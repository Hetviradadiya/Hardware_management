<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Product Management</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .form-control-sm {
        font-size: 0.8rem;
        padding: 2px 6px;
      }
      .btn-sm {
        font-size: 0.75rem;
        padding: 2px 6px;
      }
      td input {
        width: 100px;
      }
      td input[type="file"] {
        width: 75px;
      }
      .readonly-field {
        background-color: #f8f9fa;
      }
      #addRowBtn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1;
      }
      .table-responsive {
        max-height: 80vh;
        overflow-y: auto;
      }
      table thead th { white-space: nowrap; }
      .table-responsive {
        position: relative;
        overflow-x: auto;
        overflow-y: auto;
        max-height: 80vh;
      }

      /* Sticky header */
      #productTable thead th {
        position: sticky;
        top: 0;
        z-index: 3;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
      }

      /* Sticky first column for header */
      #productTable thead th:first-child {
        position: sticky;
        top: 0;
        left: 0;
        z-index: 4; /* above other header cells */
        background: #f8f9fa;
        border: 1px solid #dee2e6;
      }

      /* Sticky first column for body rows */
      #productTable tbody td:first-child {
        position: sticky;
        left: 0;
        z-index: 2; /* above normal td, below header */
        background: #fff;
        border: 1px solid #dee2e6;
      }

      /* Photo column width */
      #productTable th:first-child,
      #productTable td:first-child {
        width: 80px;
        min-width: 80px;
        max-width: 80px;
        text-align: center;
      }

      /* Optional: smooth scrollbars */
      .table-responsive::-webkit-scrollbar {
        height: 8px;
        width: 8px;
      }
      .table-responsive::-webkit-scrollbar-thumb {
        background: #ccc;
        border-radius: 4px;
      }
    </style>
  </head>
  <body class="bg-light">
    <div class="container py-3">
      <div class="text-center mb-3">
        <h2 class="fw-bold">üì¶ Product Management</h2>
      </div>

      <div class="d-flex justify-content-start mb-3">
        <input
          type="text"
          id="searchInput"
          class="form-control form-control-sm"
          placeholder="üîç Search product..."
          style="max-width: 300px"
        />
      </div>

      <div class="table-responsive">
        <table
          class="table table-bordered table-hover align-middle"
          id="productTable"
        >
          <thead class="table-light">
            <tr>
              <th>Photo</th>
              <th>HSN</th>
              <th>Name</th>
              <th>Size</th>
              <th>PCS</th>
              <th>MRP</th>
              <th>Purchase Price</th>
              <th>Purchase Disc (%)</th>
              <th>Purchase Tax (%)</th>
              <th>Purchase Total</th>
              <th>Purchase 100</th>
              <th>Purchase 100 Disc (%)</th>
              <th>Purchase 100 Tax (%)</th>
              <th>Purchase 100 Total</th>
              <th>Sale Price</th>
              <th>Sale Disc (%)</th>
              <th>Sale Tax (%)</th>
              <th>Sale Total</th>
              <th>Sale 100</th>
              <th>Sale 100 Disc (%)</th>
              <th>Sale 100 Tax (%)</th>
              <th>Sale 100 Total</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="productList"></tbody>
        </table>
      </div>

      <button id="addRowBtn" class="btn btn-primary rounded-circle">+</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    {% csrf_token %}
    <script>
      const API_URL = "/api/products/";

      // Helper: get CSRF
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
          const cookies = document.cookie.split(";");
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === name + "=") {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      }
      const csrftoken = getCookie("csrftoken");

      // =================== FETCH PRODUCTS ===================
      async function fetchProducts(query = "") {
        let url = API_URL;
        if (query) url += "?search=" + encodeURIComponent(query);
        const res = await fetch(url);
        const products = await res.json();
        renderProductList(products);
      }

      function renderProductList(products) {
        const tbody = document.getElementById("productList");
        if (!products || products.length === 0) {
          tbody.innerHTML =
            "<tr><td colspan='19' class='text-center text-muted'>No products found</td></tr>";
          return;
        }

        tbody.innerHTML = "";

        products.forEach((p) => {
          const purchaseDiscountPrice =
            p.purchase_price && p.purchase_discount
              ? (p.purchase_price * p.purchase_discount) / 100
              : 0;
          const purchaseSubtotal = (p.purchase_price || 0) - purchaseDiscountPrice;
          const purchaseTaxPrice = purchaseSubtotal * ((p.purchase_tax || 0) / 100);
          const finalPurchasePrice = purchaseSubtotal + purchaseTaxPrice;

          const saleDiscountPrice =
            p.sale_price && p.sale_discount
              ? (p.sale_price * p.sale_discount) / 100
              : 0;
          const saleSubtotal = (p.sale_price || 0) - saleDiscountPrice;
          const saleTaxPrice = saleSubtotal * ((p.sale_tax || 0) / 100);
          const finalSalePrice = saleSubtotal + saleTaxPrice;

          tbody.innerHTML += `
            <!-- First row -->
            <tr id="row_${p.id}">
              <td>${
                p.photo
                  ? `<img src="${p.photo}" style="width:50px;height:50px;object-fit:cover;">`
                  : "-"
              }</td>
              <td>${p.hsn_code || "-"}</td>
              <td>${p.name}</td>
              <td>${p.size || "-"}</td>
              <td>${p.pcs_size || "-"}</td>
              <td>${p.mrp != null ? p.mrp.toFixed(2) : "-"}</td>
              <td>${p.purchase_price != null ? p.purchase_price.toFixed(2) : "-"}</td>
              <td>${p.purchase_discount != null ? p.purchase_discount + "%" : "-"}<br>(${purchaseDiscountPrice.toFixed(2)})</td>
              <td>${p.purchase_tax != null ? p.purchase_tax + "%" : "-"}<br>(${purchaseTaxPrice.toFixed(2)})</td>
              <td>${finalPurchasePrice.toFixed(2)}</td>
              <td>${p.purchase_price_100 != null ? p.purchase_price_100.toFixed(2) : "-"}</td>
              <td>${p.purchase_discount_100 != null ? p.purchase_discount_100 + "%" : "0"}<br>(${p.purchase_discount_price_100 != null ? p.purchase_discount_price_100.toFixed(2) : "0"})</td>
              <td>${p.purchase_tax_100 != null ? p.purchase_tax_100 + "%" : "0"}<br>(${p.purchase_tax_price_100 != null ? p.purchase_tax_price_100.toFixed(2) : "0"})</td>
              <td>${p.purchase_price_100 != null && p.purchase_discount_price_100 != null && p.purchase_tax_price_100 != null 
                  ? (p.purchase_price_100 - p.purchase_discount_price_100 + p.purchase_tax_price_100).toFixed(2) 
                  : "-"}</td>
              <td>${p.sale_price != null ? p.sale_price.toFixed(2) : "-"}</td>
              <td>${p.sale_discount != null ? p.sale_discount + "%" : "0"}<br>(${saleDiscountPrice.toFixed(2)})</td>
              <td>${p.sale_tax != null ? p.sale_tax + "%" : "0"}<br>(${saleTaxPrice.toFixed(2)})</td>
              <td>${finalSalePrice.toFixed(2)}</td>
              <td>${p.sale_price_100 != null ? p.sale_price_100.toFixed(2) : "-"}</td>
              <td>${p.sale_discount_100 != null ? p.sale_discount_100 + "%" : "0"}<br>(${p.sale_discount_price_100 != null ? p.sale_discount_price_100.toFixed(2) : "0"})</td>
              <td>${p.sale_tax_100 != null ? p.sale_tax_100 + "%" : "0"}<br>(${p.sale_tax_price_100 != null ? p.sale_tax_price_100.toFixed(2) : "0"})</td>
              <td>${p.sale_price_100 != null && p.sale_discount_price_100 != null && p.sale_tax_price_100 != null
                  ? (p.sale_price_100 - p.sale_discount_price_100 + p.sale_tax_price_100).toFixed(2)
                  : "-"}</td>
              <td>
                <span class="text-warning me-2" style="cursor:pointer;" onclick="editProduct(${p.id})">‚úè</span>
                <span class="text-danger" style="cursor:pointer;" onclick="deleteProduct(${p.id})">üóë</span>
              </td>
            </tr>
          `;
        });
      }

      // =================== SEARCH ===================
      document
        .getElementById("searchInput")
        .addEventListener("keyup", (e) => fetchProducts(e.target.value.trim()));

      // =================== DELETE PRODUCT ===================
      async function deleteProduct(id) {
        if (!confirm("Are you sure?")) return;
        const res = await fetch(API_URL + id + "/", {
          method: "DELETE",
          headers: { "X-CSRFToken": csrftoken },
        });
        if (res.ok) fetchProducts();
        else alert("Delete failed");
      }

      // =================== ADD NEW INLINE ROW ===================
      document.getElementById("addRowBtn").addEventListener("click", () => {
        const tbody = document.getElementById("productList");

        if (document.getElementById("newProductRow")) return;

        const tr = document.createElement("tr");
        tr.id = "newProductRow";

        tr.innerHTML = generateEditableRow(null, true);
        tbody.prepend(tr);
        setupCalculationListeners("new");
        setupSaveCancel("new", tr);

        tr.scrollIntoView({ behavior: "smooth", block: "center" });
      });

      // =================== EDIT PRODUCT ===================
      async function editProduct(id) {
        const res = await fetch(API_URL + id + "/");
        const p = await res.json();

        const row = document.getElementById("row_" + id);
        if (!row) return;

        row.innerHTML = generateEditableRow(p, false);
        setupCalculationListeners("edit_" + id);
        setupSaveCancel("edit_" + id, row, id);
      }

      // =================== GENERATE EDITABLE ROW HTML ===================
      function generateEditableRow(p, isNew = false) {
        const prefix = isNew ? "new" : "edit_" + p.id;
        const val = (f) => (p && p[f] !== null && p[f] !== undefined ? p[f] : "");

        return `
          <td><input type="file" id="${prefix}_photo" class="form-control form-control-sm"></td>
          <td><input type="text" id="${prefix}_hsn_code" value="${val("hsn_code")}" class="form-control form-control-sm"></td>
          <td><input type="text" id="${prefix}_name" value="${val("name")}" class="form-control form-control-sm"></td>
          <td><input type="text" id="${prefix}_size" value="${val("size")}" class="form-control form-control-sm"></td>
          <td><input type="text" id="${prefix}_pcs_size" value="${val("pcs_size")}" class="form-control form-control-sm"></td>
          <td><input type="number" id="${prefix}_mrp" value="${val("mrp")}" class="form-control form-control-sm"></td>
          <td><input type="number" id="${prefix}_purchase_price" value="${val("purchase_price")}" class="form-control form-control-sm"></td>
          <td>
            <div class="two-line">
              <input type="number" id="${prefix}_purchase_discount" value="${val('purchase_discount')}" class="form-control form-control-sm" placeholder="Disc %">
              <input type="number" id="${prefix}_purchase_discount_value" class="form-control form-control-sm readonly-field" readonly placeholder="Disc value">
            </div>
          </td>
          <td>
            <div class="two-line">
              <input type="number" id="${prefix}_purchase_tax" value="${val('purchase_tax')}" class="form-control form-control-sm" placeholder="Tax %">
              <input type="number" id="${prefix}_purchase_tax_value" class="form-control form-control-sm readonly-field" readonly placeholder="Tax value">
            </div>
          </td>
          <td><input type="number" id="${prefix}_final_purchase" class="form-control form-control-sm readonly-field" readonly></td>
          <td><input type="number" id="${prefix}_purchase_price_100" value="${val("purchase_price_100")}" class="form-control form-control-sm"></td>
          <td>
            <input type="number" id="${prefix}_purchase_discount_100" value="${val('purchase_discount_100')}" class="form-control form-control-sm" placeholder="Disc % 100">
            <input type="number" id="${prefix}_purchase_discount_price_100" class="form-control form-control-sm readonly-field" readonly placeholder="Disc value 100">
          </td>
          <td>
            <input type="number" id="${prefix}_purchase_tax_100" value="${val('purchase_tax_100')}" class="form-control form-control-sm" placeholder="Tax % 100">
            <input type="number" id="${prefix}_purchase_tax_price_100" class="form-control form-control-sm readonly-field" readonly placeholder="Tax value 100">
          </td>
          <td><input type="number" id="${prefix}_final_purchase_100" class="form-control form-control-sm readonly-field" readonly></td>
          <td><input type="number" id="${prefix}_sale_price" value="${val("sale_price")}" class="form-control form-control-sm"></td>
          <td>
            <div class="two-line">
              <input type="number" id="${prefix}_sale_discount" value="${val('sale_discount')}" class="form-control form-control-sm" placeholder="Disc %">
              <input type="number" id="${prefix}_sale_discount_value" class="form-control form-control-sm readonly-field" readonly placeholder="Disc value">
            </div>
          </td>
          <td>
            <div class="two-line">
              <input type="number" id="${prefix}_sale_tax" value="${val('sale_tax')}" class="form-control form-control-sm" placeholder="Tax %">
              <input type="number" id="${prefix}_sale_tax_value" class="form-control form-control-sm readonly-field" readonly placeholder="Tax value">
            </div>
          </td>
          <td><input type="number" id="${prefix}_final_sale" class="form-control form-control-sm readonly-field" readonly></td>
          <td><input type="number" id="${prefix}_sale_price_100" value="${val("sale_price_100")}" class="form-control form-control-sm"></td>
          <td>
            <input type="number" id="${prefix}_sale_discount_100" value="${val('sale_discount_100')}" class="form-control form-control-sm" placeholder="Disc % 100">
            <input type="number" id="${prefix}_sale_discount_price_100" class="form-control form-control-sm readonly-field" readonly placeholder="Disc value 100">
          </td>
          <td>
            <input type="number" id="${prefix}_sale_tax_100" value="${val('sale_tax_100')}" class="form-control form-control-sm" placeholder="Tax % 100">
            <input type="number" id="${prefix}_sale_tax_price_100" class="form-control form-control-sm readonly-field" readonly placeholder="Tax value 100">
          </td>
          <td><input type="number" id="${prefix}_final_sale_100" class="form-control form-control-sm readonly-field" readonly></td>
          <td>
            <button class="btn btn-sm btn-success me-1" id="${prefix}_save">üíæ</button>
            <button class="btn btn-sm btn-secondary" id="${prefix}_cancel">‚úñ</button>
          </td>
        `;
      }

      // =================== CALCULATION LISTENERS ===================
      function setupCalculationListeners(prefix) {
        const updatePurchase = () => {
          const price = parseFloat(document.getElementById(prefix + "_purchase_price").value) || 0;
          const discount = parseFloat(document.getElementById(prefix + "_purchase_discount").value) || 0;
          const discountValue = (price * discount) / 100;

          const tax = parseFloat(document.getElementById(prefix + "_purchase_tax").value) || 0;
          const taxValue = (price - discountValue) * (tax / 100);

          document.getElementById(prefix + "_purchase_discount_value").value = discountValue.toFixed(2);
          document.getElementById(prefix + "_purchase_tax_value").value = taxValue.toFixed(2);
          document.getElementById(prefix + "_final_purchase").value = (price - discountValue + taxValue).toFixed(2);

          // ===== 100 calculations =====
          const price100 = parseFloat(document.getElementById(prefix + "_purchase_price_100").value) || 0;
          const discount100 = parseFloat(document.getElementById(prefix + "_purchase_discount_100").value) || 0;
          const discountValue100 = (price100 * discount100) / 100;

          const tax100 = parseFloat(document.getElementById(prefix + "_purchase_tax_100").value) || 0;
          const taxValue100 = (price100 - discountValue100) * (tax100 / 100);

          document.getElementById(prefix + "_purchase_discount_price_100").value = discountValue100.toFixed(2);
          document.getElementById(prefix + "_purchase_tax_price_100").value = taxValue100.toFixed(2);
          document.getElementById(prefix + "_final_purchase_100").value = (price100 - discountValue100 + taxValue100).toFixed(2);
        };

        const updateSale = () => {
          const price = parseFloat(document.getElementById(prefix + "_sale_price").value) || 0;
          const discount = parseFloat(document.getElementById(prefix + "_sale_discount").value) || 0;
          const discountValue = (price * discount) / 100;

          const tax = parseFloat(document.getElementById(prefix + "_sale_tax").value) || 0;
          const taxValue = (price - discountValue) * (tax / 100);

          document.getElementById(prefix + "_sale_discount_value").value = discountValue.toFixed(2);
          document.getElementById(prefix + "_sale_tax_value").value = taxValue.toFixed(2);
          document.getElementById(prefix + "_final_sale").value = (price - discountValue + taxValue).toFixed(2);

          // ===== 100 calculations =====
          const price100 = parseFloat(document.getElementById(prefix + "_sale_price_100").value) || 0;
          const discount100 = parseFloat(document.getElementById(prefix + "_sale_discount_100").value) || 0;
          const discountValue100 = (price100 * discount100) / 100;

          const tax100 = parseFloat(document.getElementById(prefix + "_sale_tax_100").value) || 0;
          const taxValue100 = (price100 - discountValue100) * (tax100 / 100);

          document.getElementById(prefix + "_sale_discount_price_100").value = discountValue100.toFixed(2);
          document.getElementById(prefix + "_sale_tax_price_100").value = taxValue100.toFixed(2);
          document.getElementById(prefix + "_final_sale_100").value = (price100 - discountValue100 + taxValue100).toFixed(2);
        };

        ["purchase_price", "purchase_discount", "purchase_tax", "purchase_price_100", "purchase_discount_100", "purchase_tax_100"].forEach(f =>
          document.getElementById(prefix + "_" + f).addEventListener("input", updatePurchase)
        );

        ["sale_price", "sale_discount", "sale_tax", "sale_price_100", "sale_discount_100", "sale_tax_100"].forEach(f =>
          document.getElementById(prefix + "_" + f).addEventListener("input", updateSale)
        );

        updatePurchase();
        updateSale();
      }
      // =================== SAVE & CANCEL ===================
      function setupSaveCancel(prefix, tr, id = null) {
        document.getElementById(prefix + "_cancel").addEventListener("click", () => {
          fetchProducts();
        });

        document.getElementById(prefix + "_save").addEventListener("click", async () => {
          const formData = new FormData();
          [
            "hsn_code","name","size","pcs_size","mrp",
            "purchase_price","purchase_discount","purchase_tax",
            "purchase_price_100","purchase_discount_100","purchase_discount_price_100","purchase_tax_100","purchase_tax_price_100",
            "sale_price","sale_discount","sale_tax",
            "sale_price_100","sale_discount_100","sale_discount_price_100","sale_tax_100","sale_tax_price_100",
          ].forEach((f) => {
            const el = document.getElementById(prefix + "_" + f);
            if (el) formData.append(f, el.value);
          });
          formData.append("final_purchase", document.getElementById(prefix + "_final_purchase").value);
          formData.append("final_sale", document.getElementById(prefix + "_final_sale").value);
          const photoFile = document.getElementById(prefix + "_photo").files[0];
          if (photoFile) formData.append("photo", photoFile);

          const method = id ? "PATCH" : "POST";
          const url = id ? API_URL + id + "/" : API_URL;

          const res = await fetch(url, {
            method,
            body: formData,
            headers: { "X-CSRFToken": csrftoken },
          });
          if (res.ok) {
            fetchProducts();
          } else alert("Error saving");
        });
      }

      // =================== INITIAL LOAD ===================
      fetchProducts();
    </script>
  </body>
</html>
