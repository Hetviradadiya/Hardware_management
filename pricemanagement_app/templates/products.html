<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Mobile Product Entry</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #f8f9fa;
      }
      input[type="number"],
      input[type="text"],
      input[type="date"] {
        width: 100px;
      }
      .table-responsive {
        max-height: 80vh;
        overflow: auto;
      }
      table th,
      table td {
        white-space: nowrap;
        vertical-align: middle;
      }
      .readonly-field {
        background-color: #e9ecef;
      }
    </style>
  </head>
  <body>
    <div class="container py-3">
      <h3 class="mb-3 text-center">📦 Product Entry</h3>

      <div class="table-responsive">
        <table
          class="table table-bordered table-hover align-middle"
          id="productTable"
        >
          <thead class="table-light">
            <tr>
              <th>Photo</th>
              <th>Name</th>
              <th>Size</th>
              <th>Code</th>
              <th>HSN</th>
              <th>MRP</th>
              <th>Payment Type</th>
              <th>Price</th>
              <th>Discount<br><small>(%/Price)</small></th>
              <th>Tax<br><small>(%/Price)</small></th>
              <th>Box</th>
              <th>Box Discount<br><small>(%/Price)</small></th>
              <th>Box Tax<br><small>(%/Price)</small></th>
              <th>Dealer Name</th>
              <th>Slol</th>
              <th>Date</th>
              <th>Dealer Price</th>
              <th>Dealer Discount<br><small>(%/Price)</small></th>
              <th>Dealer Tax<br><small>(%/Price)</small></th>
              <th>Dealer Box</th>
              <th>Dealer Box Discount<br><small>(%/Price)</small></th>
              <th>Dealer Box Tax<br><small>(%/Price)</small></th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="productList"></tbody>
        </table>
      </div>

      <button class="btn btn-primary mt-2 w-100" id="addProductBtn">
        + Add Product
      </button>
      <button class="btn btn-success mt-2 w-100" id="saveProductsBtn">
        💾 Save Products
      </button>
    </div>

    <script>
      let productCount = 0;
      let priceCount = 0;
      let sizeCount = 0;

      function createInput(
        type = "text",
        value = "",
        classes = "form-control",
        extra = ""
      ) {
        return `<input type="${type}" class="${classes}" value="${value}" ${extra}>`;
      }

      function calc(value, percent) {
        const v = parseFloat(value || 0);
        const p = parseFloat(percent || 0);
        return ((v * p) / 100).toFixed(2);
      }

      // --- Add Dealer Row ---
      function addDealerRow(priceRow, productId, sizeId, priceId) {
        const dealerRow = document.createElement("tr");
        dealerRow.classList.add(
          `product_${productId}_size_${sizeId}_price_${priceId}_dealer`
        );

        dealerRow.innerHTML = `
        <td colspan="17"></td>
        <td>${createInput("text")}</td>
        <td>${createInput("text")}</td>
        <td>${createInput("date")}</td>
        <td>
          <div>${createInput("number", "", "form-control", 'placeholder="%" oninput="updateDealerCalc(this)"')}</div>
          <small class="text-muted">₹${createInput("number", "", "form-control readonly-field", 'readonly tabindex="-1" style="font-size:10px;height:20px;"')}</small>
        </td>
        <td>
          <div>${createInput("number", "", "form-control", 'placeholder="%" oninput="updateDealerCalc(this)"')}</div>
          <small class="text-muted">₹${createInput("number", "", "form-control readonly-field", 'readonly tabindex="-1" style="font-size:10px;height:20px;"')}</small>
        </td>
        <td>${createInput(
          "number",
          "",
          "form-control",
          'oninput="updateDealerCalc(this)"'
        )}</td>
        <td>
          <div>${createInput("number", "", "form-control", 'placeholder="%" oninput="updateDealerCalc(this)"')}</div>
          <small class="text-muted">₹${createInput("number", "", "form-control readonly-field", 'readonly tabindex="-1" style="font-size:10px;height:20px;"')}</small>
        </td>
        <td>
          <div>${createInput("number", "", "form-control", 'placeholder="%" oninput="updateDealerCalc(this)"')}</div>
          <small class="text-muted">₹${createInput("number", "", "form-control readonly-field", 'readonly tabindex="-1" style="font-size:10px;height:20px;"')}</small>
        </td>
        <td>${createInput(
          "number",
          "",
          "form-control",
          'oninput="updateDealerCalc(this)"'
        )}</td>
        <td>
          <button class="btn btn-sm btn-danger" onclick="this.closest('tr').remove()">🗑</button>
        </td>
        `;

        const existingDealers = document.querySelectorAll(
          `.product_${productId}_size_${sizeId}_price_${priceId}_dealer`
        );
        const insertAfter = existingDealers.length
          ? existingDealers[existingDealers.length - 1]
          : priceRow;
        insertAfter.parentNode.insertBefore(dealerRow, insertAfter.nextSibling);
      }

      // --- Add Price Row ---
      function addPriceRow(productId, sizeId) {
        const priceId = priceCount++;
        const priceRow = document.createElement("tr");
        priceRow.classList.add(`product_${productId}_size_${sizeId}_price`);
        priceRow.dataset.priceId = priceId;

        priceRow.innerHTML = `
        <td colspan="6"></td>
        <td>
          <select class="form-control">
            <option value="">Select Payment Type</option>
            <option value="cash">Cash</option>
            <option value="bill">Bill</option>
            <option value="sale_cash">Sale Cash</option>
            <option value="sale_bill">Sale Bill</option>
            <option value="frd_cash">Frd Cash</option>
            <option value="frd_bill">Frd Bill</option>
          </select>
        </td>
        <td>${createInput("number", "", "form-control", 'placeholder="Price" oninput="updatePriceCalc(this)"')}</td>
        <td>
          <div>${createInput("number", "", "form-control", 'placeholder="%" oninput="updatePriceCalc(this)"')}</div>
          <small class="text-muted">₹${createInput("number", "", "form-control readonly-field", 'readonly tabindex="-1" style="font-size:10px;height:20px;"')}</small>
        </td>
        <td>
          <div>${createInput("number", "", "form-control", 'placeholder="%" oninput="updatePriceCalc(this)"')}</div>
          <small class="text-muted">₹${createInput("number", "", "form-control readonly-field", 'readonly tabindex="-1" style="font-size:10px;height:20px;"')}</small>
        </td>
        <td>${createInput(
          "number",
          "",
          "form-control",
          'oninput="updatePriceCalc(this)"'
        )}</td>
        <td>
          <div>${createInput("number", "", "form-control", 'placeholder="%" oninput="updatePriceCalc(this)"')}</div>
          <small class="text-muted">₹${createInput("number", "", "form-control readonly-field", 'readonly tabindex="-1" style="font-size:10px;height:20px;"')}</small>
        </td>
        <td>
          <div>${createInput("number", "", "form-control", 'placeholder="%" oninput="updatePriceCalc(this)"')}</div>
          <small class="text-muted">₹${createInput("number", "", "form-control readonly-field", 'readonly tabindex="-1" style="font-size:10px;height:20px;"')}</small>
        </td>
        <td>${createInput(
          "number",
          "",
          "form-control",
          'oninput="updatePriceCalc(this)"'
        )}</td>
        <td>${createInput(
          "number",
          "",
          "form-control",
          'oninput="updatePriceCalc(this)"'
        )}</td>
        <td>${createInput(
          "number",
          "",
          "form-control",
          'oninput="updatePriceCalc(this)"'
        )}</td>
        <td>${createInput(
          "number",
          "",
          "form-control",
        )}</td>
        <td colspan="10">
          <button class="btn btn-sm btn-info" onclick="addDealerRow(this.closest('tr'),${productId},${sizeId},${priceId})">+ Dealer</button>
          <button class="btn btn-sm btn-danger" onclick="this.closest('tr').remove()">🗑</button>
        </td>
        `;

        // Simple insertion logic: find the target size row and insert right after it
        const targetSizeRow = Array.from(document.querySelectorAll(`tr`)).find(row => 
          row.classList.contains(`product_${productId}_size`) && 
          row.dataset.sizeId == sizeId
        );
        
        if (targetSizeRow) {
          targetSizeRow.insertAdjacentElement('afterend', priceRow);
        } else {
          // Fallback: insert after product row
          const productRow = document.getElementById(`product_${productId}`);
          productRow.insertAdjacentElement('afterend', priceRow);
        }
      }

      // --- Add Size Row ---
      function addSizeRow(productId) {
        const sizeId = sizeCount++;
        const sizeRow = document.createElement("tr");
        sizeRow.classList.add(`product_${productId}_size`);
        sizeRow.dataset.sizeId = sizeId;
        sizeRow.innerHTML = `
          <td colspan="2"></td>
          <td>${createInput("text", "", "form-control", 'placeholder="Size"')}</td>
          <td>${createInput("text", "", "form-control", 'placeholder="Product Code"')}</td>
          <td>${createInput("text", "", "form-control", 'placeholder="HSN Code"')}</td>
          <td>${createInput("number", "", "form-control", 'placeholder="MRP" step="0.01"')}</td>
          <td colspan="17">
            <button class="btn btn-sm btn-success" onclick="addPriceRow(${productId},${sizeId})">+ Add Price</button>
            <button class="btn btn-sm btn-secondary" onclick="this.closest('tr').remove()">✖ Delete Size</button>
          </td>
        `;
        const productRow = document.getElementById(`product_${productId}`);
        productRow.parentNode.insertBefore(sizeRow, productRow.nextSibling);
      }

      // --- Add Product Row ---
      function addProductRow() {
        const tbody = document.getElementById("productList");
        const productId = productCount++;
        const productRow = document.createElement("tr");
        productRow.id = `product_${productId}`;
        productRow.innerHTML = `
        <td>${createInput("file")}</td>
        <td>${createInput("text")}</td>
        <td colspan="21">
          <button class="btn btn-sm btn-success" onclick="addSizeRow(${productId})">+ Add Size</button>
          <button class="btn btn-sm btn-secondary" onclick="this.closest('tr').remove()">✖ Delete Product</button>
        </td>
      `;
        tbody.appendChild(productRow);
      }

      // --- Price Calculations ---
      function updatePriceCalc(element) {
        const row = element.closest("tr");
        const inputs = row.querySelectorAll("input");
        
        // Price calculations
        const price = parseFloat(inputs[1]?.value || 0);
        const discountPercent = parseFloat(inputs[2]?.value || 0);
        const taxPercent = parseFloat(inputs[4]?.value || 0);
        
        const discountAmount = parseFloat(calc(price, discountPercent));
        const priceAfterDiscount = price - discountAmount;
        const taxAmount = parseFloat(calc(priceAfterDiscount, taxPercent));
        const finalTotal = priceAfterDiscount + taxAmount;
        
        // Show discount amount in the small field under discount %
        if (inputs[3]) inputs[3].value = discountAmount.toFixed(2);
        // Show tax amount in the small field under tax %
        if (inputs[5]) inputs[5].value = taxAmount.toFixed(2);
        
        console.log(`Price: ${price}, Discount: ${discountPercent}% = ₹${discountAmount}, Final after discount: ₹${priceAfterDiscount.toFixed(2)}, Tax: ₹${taxAmount}, Total: ₹${finalTotal.toFixed(2)}`);

        // Box calculations
        const boxQty = parseFloat(inputs[6]?.value || 0);
        const boxDiscountPercent = parseFloat(inputs[7]?.value || 0);
        const boxTaxPercent = parseFloat(inputs[9]?.value || 0);
        
        if (boxQty > 0) {
          const boxPrice = price * boxQty;
          const boxDiscountAmount = parseFloat(calc(boxPrice, boxDiscountPercent));
          const boxPriceAfterDiscount = boxPrice - boxDiscountAmount;
          const boxTaxAmount = parseFloat(calc(boxPriceAfterDiscount, boxTaxPercent));
          
          if (inputs[8]) inputs[8].value = boxDiscountAmount.toFixed(2);
          if (inputs[10]) inputs[10].value = boxTaxAmount.toFixed(2);
        }
      }

      // --- Dealer Calculations ---
      function updateDealerCalc(element) {
        const row = element.closest("tr");
        const inputs = row.querySelectorAll("input");
        
        // Purchase price calculations
        const purchasePrice = parseFloat(inputs[3]?.value || 0);
        const purchaseDiscountPercent = parseFloat(inputs[4]?.value || 0);
        const purchaseTaxPercent = parseFloat(inputs[6]?.value || 0);
        
        const purchaseDiscountAmount = parseFloat(calc(purchasePrice, purchaseDiscountPercent));
        const purchasePriceAfterDiscount = purchasePrice - purchaseDiscountAmount;
        const purchaseTaxAmount = parseFloat(calc(purchasePriceAfterDiscount, purchaseTaxPercent));
        
        if (inputs[5]) inputs[5].value = purchaseDiscountAmount.toFixed(2);
        if (inputs[7]) inputs[7].value = purchaseTaxAmount.toFixed(2);

        // Purchase box calculations
        const purchaseBoxQty = parseFloat(inputs[8]?.value || 0);
        const purchaseBoxDiscountPercent = parseFloat(inputs[9]?.value || 0);
        const purchaseBoxTaxPercent = parseFloat(inputs[11]?.value || 0);
        
        if (purchaseBoxQty > 0) {
          const purchaseBoxPrice = purchasePrice * purchaseBoxQty;
          const purchaseBoxDiscountAmount = parseFloat(calc(purchaseBoxPrice, purchaseBoxDiscountPercent));
          const purchaseBoxPriceAfterDiscount = purchaseBoxPrice - purchaseBoxDiscountAmount;
          const purchaseBoxTaxAmount = parseFloat(calc(purchaseBoxPriceAfterDiscount, purchaseBoxTaxPercent));
          
          if (inputs[10]) inputs[10].value = purchaseBoxDiscountAmount.toFixed(2);
          if (inputs[12]) inputs[12].value = purchaseBoxTaxAmount.toFixed(2);
        }
      }

      document
        .getElementById("addProductBtn")
        .addEventListener("click", addProductRow);

            document
        .getElementById("saveProductsBtn")
        .addEventListener("click", () => {
          const data = [];
          const productRows = document.querySelectorAll(
            '#productList tr[id^="product_"]'
          );

          productRows.forEach((pRow) => {
            const productId = pRow.id.split("_")[1];
            const productInputs = pRow.querySelectorAll("input");
            
            // Create Product data
            const productData = {
              name: productInputs[1]?.value || "",
              sizes: []
            };

            // Get all size rows for this product
            const sizeRows = document.querySelectorAll(`.product_${productId}_size`);
            sizeRows.forEach(sizeRow => {
              const sizeId = sizeRow.dataset.sizeId;
              const sizeInputs = sizeRow.querySelectorAll("input");
              const sizeData = {
                size: sizeInputs[0]?.value || "",
                code: sizeInputs[1]?.value || "",
                hsn: sizeInputs[2]?.value || "",
                mrp: parseFloat(sizeInputs[3]?.value || 0),
                prices: [] // Prices now belong to ProductSize
              };

              // Get all price rows for this specific size
              const priceRows = document.querySelectorAll(`.product_${productId}_size_${sizeId}_price`);
              priceRows.forEach(priceRow => {
                const priceId = priceRow.dataset.priceId;
                const priceInputs = priceRow.querySelectorAll("input, select");
                const priceData = {
                  payment_type: priceInputs[0]?.value || "",
                  price: parseFloat(priceInputs[1]?.value || 0),
                  discount: parseFloat(priceInputs[2]?.value || 0),
                  discount_price: parseFloat(priceInputs[3]?.value || 0),
                  tax: parseFloat(priceInputs[4]?.value || 0),
                  tax_price: parseFloat(priceInputs[5]?.value || 0),
                  box: parseFloat(priceInputs[6]?.value || 0),
                  box_discount: parseFloat(priceInputs[7]?.value || 0),
                  box_discount_price: parseFloat(priceInputs[8]?.value || 0),
                  box_tax: parseFloat(priceInputs[9]?.value || 0),
                  box_tax_price: parseFloat(priceInputs[10]?.value || 0),
                  dealers: []
                };

                // Get dealer rows for this price
                const dealerRows = document.querySelectorAll(`.product_${productId}_size_${sizeId}_price_${priceId}_dealer`);
                dealerRows.forEach(dealerRow => {
                  const dealerInputs = dealerRow.querySelectorAll("input");
                  const dealerData = {
                    dlr_name: dealerInputs[0]?.value || "",
                    slol: dealerInputs[1]?.value || "",
                    purchase_date: dealerInputs[2]?.value || "",
                    purchase_price: parseFloat(dealerInputs[3]?.value || 0),
                    purchase_discount: parseFloat(dealerInputs[4]?.value || 0),
                    purchase_discount_price: parseFloat(dealerInputs[5]?.value || 0),
                    purchase_tax: parseFloat(dealerInputs[6]?.value || 0),
                    purchase_tax_price: parseFloat(dealerInputs[7]?.value || 0),
                    purchase_box: parseFloat(dealerInputs[8]?.value || 0),
                    purchase_box_discount: parseFloat(dealerInputs[9]?.value || 0),
                    purchase_box_discount_price: parseFloat(dealerInputs[10]?.value || 0),
                    purchase_box_tax: parseFloat(dealerInputs[11]?.value || 0),
                    purchase_box_tax_price: parseFloat(dealerInputs[12]?.value || 0)
                  };
                  priceData.dealers.push(dealerData);
                });

                sizeData.prices.push(priceData);
              });

              productData.sizes.push(sizeData);
            });

            data.push(productData);
          });

          console.log("✅ Final Data:", JSON.stringify(data, null, 2));

          // --- Send each product separately ---
          data.forEach(async (productData, index) => {
            try {
              const response = await fetch("/api/product-create/", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  "X-CSRFToken": getCookie("csrftoken"),
                },
                body: JSON.stringify(productData),
              });
              
              const result = await response.json();
              
              if (response.ok) {
                console.log(`✅ Product ${index + 1} saved:`, result);
              } else {
                console.error(`❌ Error saving product ${index + 1}:`, result);
                alert(`Error saving product ${index + 1}: ${JSON.stringify(result)}`);
              }
            } catch (err) {
              console.error(`❌ Network error for product ${index + 1}:`, err);
              alert(`Network error saving product ${index + 1}`);
            }
          });
          
          alert(`Attempting to save ${data.length} products. Check console for details.`);
        });

      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
          const cookies = document.cookie.split(";");
          for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + "=")) {
              cookieValue = decodeURIComponent(
                cookie.substring(name.length + 1)
              );
              break;
            }
          }
        }
        return cookieValue;
      }
      // Removed old incorrect display function

      // Override the display function to handle nested structure correctly
      function displayProductsWithNestedStructure() {
        fetch("/api/product-create/")
          .then((res) => res.json())
          .then((data) => {
            const tbody = document.getElementById("productList");
            tbody.innerHTML = ""; // clear old

            data.forEach((product) => {
              const sizes = product.sizes || [];

              // calculate total rows for product rowspan
              let totalRows = 0;
              sizes.forEach((size) => {
                const prices = size.prices || [];
                if (prices.length === 0) {
                  totalRows += 1; // size with no prices
                } else {
                  prices.forEach((price) => {
                    totalRows += Math.max((price.dealers && price.dealers.length) || 1, 1);
                  });
                }
              });
              if (totalRows === 0) totalRows = 1; // product with no sizes

              let currentRowIndex = 0;
              let firstProductRow = true;

              if (sizes.length > 0) {
                sizes.forEach((size, sIndex) => {
                  const prices = size.prices || [];
                  let sizeRowsCount = 0;
                  
                  // Calculate rows for this size
                  if (prices.length === 0) {
                    sizeRowsCount = 1;
                  } else {
                    prices.forEach((price) => {
                      sizeRowsCount += Math.max((price.dealers && price.dealers.length) || 1, 1);
                    });
                  }

                  let firstSizeRow = true;

                  if (prices.length > 0) {
                    prices.forEach((price, pIndex) => {
                      const dealers = price.dealers || [];
                      const priceRowspan = Math.max(dealers.length, 1);

                      if (dealers.length > 0) {
                        dealers.forEach((dealer, dIndex) => {
                          const tr = document.createElement("tr");
                          tr.innerHTML = `
                            ${firstProductRow ? `<td rowspan="${totalRows}">${product.photo ? `<img src="${product.photo}" alt="Photo" width="50">` : ""}</td>` : ""}
                            ${firstProductRow ? `<td rowspan="${totalRows}">${product.name || ""}</td>` : ""}
                            ${firstSizeRow ? `<td rowspan="${sizeRowsCount}">${size.size || ""}</td>` : ""}
                            ${firstSizeRow ? `<td rowspan="${sizeRowsCount}">${size.code || ""}</td>` : ""}
                            ${firstSizeRow ? `<td rowspan="${sizeRowsCount}">${size.hsn || ""}</td>` : ""}
                            ${firstSizeRow ? `<td rowspan="${sizeRowsCount}">${size.mrp || ""}</td>` : ""}
                            ${dIndex === 0 ? `<td rowspan="${priceRowspan}">${price.payment_type || ""}</td>` : ""}
                            ${dIndex === 0 ? `<td rowspan="${priceRowspan}">${price.price || ""}</td>` : ""}
                            ${dIndex === 0 ? `<td rowspan="${priceRowspan}"><div>${price.discount || ""}%</div><small class="text-muted">₹${price.discount_price || ""}</small></td>` : ""}
                            ${dIndex === 0 ? `<td rowspan="${priceRowspan}"><div>${price.tax || ""}%</div><small class="text-muted">₹${price.tax_price || ""}</small></td>` : ""}
                            ${dIndex === 0 ? `<td rowspan="${priceRowspan}">${price.box || ""}</td>` : ""}
                            ${dIndex === 0 ? `<td rowspan="${priceRowspan}"><div>${price.box_discount || ""}%</div><small class="text-muted">₹${price.box_discount_price || ""}</small></td>` : ""}
                            ${dIndex === 0 ? `<td rowspan="${priceRowspan}"><div>${price.box_tax || ""}%</div><small class="text-muted">₹${price.box_tax_price || ""}</small></td>` : ""}
                            <td>${dealer?.dlr_name || ""}</td>
                            <td>${dealer?.slol || ""}</td>
                            <td>${dealer?.purchase_date || ""}</td>
                            <td>${dealer?.purchase_price || ""}</td>
                            <td><div>${dealer?.purchase_discount || ""}%</div><small class="text-muted">₹${dealer?.purchase_discount_price || ""}</small></td>
                            <td><div>${dealer?.purchase_tax || ""}%</div><small class="text-muted">₹${dealer?.purchase_tax_price || ""}</small></td>
                            <td>${dealer?.purchase_box || ""}</td>
                            <td><div>${dealer?.purchase_box_discount || ""}%</div><small class="text-muted">₹${dealer?.purchase_box_discount_price || ""}</small></td>
                            <td><div>${dealer?.purchase_box_tax || ""}%</div><small class="text-muted">₹${dealer?.purchase_box_tax_price || ""}</small></td>
                            <td>
                              <button class="btn btn-sm btn-success">✎ Edit</button>
                              <button class="btn btn-sm btn-danger">🗑 Delete</button>
                            </td>
                          `;
                          tbody.appendChild(tr);
                          firstProductRow = false;
                          firstSizeRow = false;
                        });
                      } else {
                        // Price with no dealers
                        const tr = document.createElement("tr");
                        tr.innerHTML = `
                          ${firstProductRow ? `<td rowspan="${totalRows}">${product.photo ? `<img src="${product.photo}" alt="Photo" width="50">` : ""}</td>` : ""}
                          ${firstProductRow ? `<td rowspan="${totalRows}">${product.name || ""}</td>` : ""}
                          ${firstSizeRow ? `<td rowspan="${sizeRowsCount}">${size.size || ""}</td>` : ""}
                          ${firstSizeRow ? `<td rowspan="${sizeRowsCount}">${size.code || ""}</td>` : ""}
                          ${firstSizeRow ? `<td rowspan="${sizeRowsCount}">${size.hsn || ""}</td>` : ""}
                          ${firstSizeRow ? `<td rowspan="${sizeRowsCount}">${size.mrp || ""}</td>` : ""}
                          <td>${price.payment_type || ""}</td>
                          <td>${price.price || ""}</td>
                          <td><div>${price.discount || ""}%</div><small class="text-muted">₹${price.discount_price || ""}</small></td>
                          <td><div>${price.tax || ""}%</div><small class="text-muted">₹${price.tax_price || ""}</small></td>
                          <td>${price.box || ""}</td>
                          <td><div>${price.box_discount || ""}%</div><small class="text-muted">₹${price.box_discount_price || ""}</small></td>
                          <td><div>${price.box_tax || ""}%</div><small class="text-muted">₹${price.box_tax_price || ""}</small></td>
                          <td colspan="9">No dealers</td>
                          <td>
                            <button class="btn btn-sm btn-success">✎ Edit</button>
                            <button class="btn btn-sm btn-danger">🗑 Delete</button>
                          </td>
                        `;
                        tbody.appendChild(tr);
                        firstProductRow = false;
                        firstSizeRow = false;
                      }
                    });
                  } else {
                    // Size with no prices
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                      ${firstProductRow ? `<td rowspan="${totalRows}">${product.photo ? `<img src="${product.photo}" alt="Photo" width="50">` : ""}</td>` : ""}
                      ${firstProductRow ? `<td rowspan="${totalRows}">${product.name || ""}</td>` : ""}
                      <td>${size.size || ""}</td>
                      <td>${size.code || ""}</td>
                      <td>${size.hsn || ""}</td>
                      <td>${size.mrp || ""}</td>
                      <td colspan="18">No prices defined</td>
                      <td>
                        <button class="btn btn-sm btn-success">✎ Edit</button>
                        <button class="btn btn-sm btn-danger">🗑 Delete</button>
                      </td>
                    `;
                    tbody.appendChild(tr);
                    firstProductRow = false;
                  }
                });
              } else {
                // Product with no sizes
                const tr = document.createElement("tr");
                tr.innerHTML = `
                  <td>${product.photo ? `<img src="${product.photo}" alt="Photo" width="50">` : ""}</td>
                  <td>${product.name || ""}</td>
                  <td colspan="4">No sizes defined</td>
                  <td colspan="18"></td>
                  <td>
                    <button class="btn btn-sm btn-success">✎ Edit</button>
                    <button class="btn btn-sm btn-danger">🗑 Delete</button>
                  </td>
                `;
                tbody.appendChild(tr);
              }
            });
          })
          .catch((err) => console.error("Error loading products:", err));
      }

      // Call the correct function when page loads
      window.addEventListener("DOMContentLoaded", () => {
        displayProductsWithNestedStructure();
      });
      
    </script>
  </body>
</html>
