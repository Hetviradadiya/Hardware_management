<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Product Management</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .card { border-radius: 12px; }
    .product-img { max-height: 80px; object-fit: cover; border-radius: 8px; }
    .mobile-form { max-width: 600px; margin: auto; display: none; }
    .form-label { font-size: 0.9rem; }
    .form-control { font-size: 0.9rem; padding: 6px 10px; }
    .card-title { font-size: 1rem; font-weight: 600; }
    .card-text { font-size: 0.85rem; line-height: 1.4; }
    .btn-sm { font-size: 0.8rem; padding: 4px 10px; }
    .calc-output { font-size: 0.85rem; color: #444; }
  </style>
</head>
<body class="bg-light">

<div class="container py-3">

  <div class="text-center mb-3">
    <h2 class="fw-bold">üì¶ Product Management</h2>
  </div>

  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
    <input type="text" id="searchInput" class="form-control" placeholder="üîç Search product..." style="max-width: 300px;">
    <button class="btn btn-success btn-sm" id="toggleFormBtn">‚ûï Add Product</button>
  </div>

  <!-- Product Form -->
  <div class="card shadow-sm mb-4 mobile-form" id="productFormCard">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 id="formTitle">Add Product</h5>
        <button class="btn btn-sm btn-outline-secondary" id="closeFormBtn">‚úñ</button>
      </div>

      <form id="productForm">
        <input type="hidden" id="productId">
        <div class="row g-2">

          <div class="col-md-6">
            <label class="form-label">HSN Code</label>
            <input type="text" id="hsn_code" class="form-control">
          </div>
          <div class="col-md-6">
            <label class="form-label">Name</label>
            <input type="text" id="name" class="form-control" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Size</label>
            <input type="text" id="size" class="form-control">
          </div>
          <div class="col-md-6">
            <label class="form-label">PCS Size</label>
            <input type="text" id="pcs_size" class="form-control">
          </div>

          <div class="col-md-6">
            <label class="form-label">MRP</label>
            <input type="number" id="mrp" class="form-control">
          </div>

          <div class="col-md-6">
            <label class="form-label">Purchase Price</label>
            <input type="number" id="purchase_price" class="form-control">
          </div>
          <div class="col-md-6">
            <label class="form-label">Purchase Discount (%)</label>
            <input type="number" id="purchase_discount" class="form-control">
          </div>
          <div class="col-md-6">
            <label class="form-label">Purchase Tax (%)</label>
            <input type="number" id="purchase_tax" class="form-control">
          </div>

          <!-- Calculated Purchase Values -->
          <div class="col-md-12 calc-output">
            <p>Purchase Discount Amount: ‚Çπ<span id="calc_purchase_discount">0.00</span></p>
            <p>Purchase Tax Amount: ‚Çπ<span id="calc_purchase_tax">0.00</span></p>
            <p>Final Purchase Price: ‚Çπ<span id="calc_final_purchase">0.00</span></p>
          </div>

          <div class="col-md-6">
            <label class="form-label">Sale Price</label>
            <input type="number" id="sale_price" class="form-control">
          </div>
          <div class="col-md-6">
            <label class="form-label">Sale Discount (%)</label>
            <input type="number" id="sale_discount" class="form-control">
          </div>
          <div class="col-md-6">
            <label class="form-label">Sale Tax (%)</label>
            <input type="number" id="sale_tax" class="form-control">
          </div>

          <!-- Calculated Sale Values -->
          <div class="col-md-12 calc-output">
            <p>Sale Discount Amount: ‚Çπ<span id="calc_sale_discount">0.00</span></p>
            <p>Sale Tax Amount: ‚Çπ<span id="calc_sale_tax">0.00</span></p>
            <p>Final Sale Price: ‚Çπ<span id="calc_final_sale">0.00</span></p>
          </div>

          <div class="col-md-12">
            <label class="form-label">Photo</label>
            <input type="file" id="photo" class="form-control">
          </div>
        </div>

        <button type="submit" class="btn btn-primary w-100 mt-3">Save</button>
      </form>
    </div>
  </div>

  <div class="row" id="productList"></div>

</div>

<!-- Bootstrap + JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const API_URL = "/api/products/";

  // ----------- CALCULATION FUNCTION -----------
  function calculateFinals() {
    const purchasePrice = parseFloat(document.getElementById("purchase_price").value) || 0;
    const purchaseDiscount = parseFloat(document.getElementById("purchase_discount").value) || 0;
    const purchaseTax = parseFloat(document.getElementById("purchase_tax").value) || 0;

    const salePrice = parseFloat(document.getElementById("sale_price").value) || 0;
    const saleDiscount = parseFloat(document.getElementById("sale_discount").value) || 0;
    const saleTax = parseFloat(document.getElementById("sale_tax").value) || 0;

    // Purchase calculations
    const purchaseDiscountPrice = (purchasePrice * purchaseDiscount) / 100;
    const purchaseSubtotal = purchasePrice - purchaseDiscountPrice;
    const purchaseTaxPrice = (purchaseSubtotal * purchaseTax) / 100;
    const finalPurchasePrice = purchaseSubtotal + purchaseTaxPrice;

    // Sale calculations
    const saleDiscountPrice = (salePrice * saleDiscount) / 100;
    const saleSubtotal = salePrice - saleDiscountPrice;
    const saleTaxPrice = (saleSubtotal * saleTax) / 100;
    const finalSalePrice = saleSubtotal + saleTaxPrice;

    return {
      purchaseDiscountPrice,
      purchaseTaxPrice,
      finalPurchasePrice,
      saleDiscountPrice,
      saleTaxPrice,
      finalSalePrice
    };
  }

  // ----------- EVENT BINDING FOR AUTO CALCULATION -----------
  ["purchase_price","purchase_discount","purchase_tax","sale_price","sale_discount","sale_tax"]
    .forEach(id => {
      document.getElementById(id).addEventListener("input", () => {
        const vals = calculateFinals();
        console.log("Purchase Total:", vals.finalPurchasePrice.toFixed(2),
                    "Sale Total:", vals.finalSalePrice.toFixed(2));
      });
    });

  // ----------- FETCH PRODUCTS -----------
  async function fetchProducts(query="") {
    let url = API_URL;
    if(query) url += "?search=" + encodeURIComponent(query);
    const res = await fetch(url);
    const products = await res.json();
    let html = "";
    products.forEach(p => {
      // auto-calculate final prices for display
      const purchaseDiscountPrice = (p.purchase_price * p.purchase_discount)/100;
      const purchaseSubtotal = p.purchase_price - purchaseDiscountPrice;
      const purchaseTaxPrice = (purchaseSubtotal * p.purchase_tax)/100;
      const finalPurchasePrice = purchaseSubtotal + purchaseTaxPrice;

      const saleDiscountPrice = (p.sale_price * p.sale_discount)/100;
      const saleSubtotal = p.sale_price - saleDiscountPrice;
      const saleTaxPrice = (saleSubtotal * p.sale_tax)/100;
      const finalSalePrice = saleSubtotal + saleTaxPrice;

      html += `
      <div class="col-md-4 col-12 mb-3">
        <div class="card shadow-sm h-100">
          ${p.photo ? `<img src="${p.photo}" class="card-img-top product-img" alt="${p.name}">` : ""}
          <div class="card-body">
            <h5 class="card-title">${p.name}</h5>
            <p class="card-text">
              <strong>HSN:</strong> ${p.hsn_code||"-"} <br>
              <strong>Size:</strong> ${p.size||"-"} | <strong>PCS:</strong> ${p.pcs_size||"-"} <br>
              <strong>MRP:</strong> ${p.mrp} <br>
              <strong>Purchase:</strong> ${p.purchase_price} ‚Üí ${finalPurchasePrice.toFixed(2)} <br>
              <strong>Sale:</strong> ${p.sale_price} ‚Üí ${finalSalePrice.toFixed(2)} <br>
              <strong>Purchase Disc:</strong> ${p.purchase_discount}% | <strong>Sale Disc:</strong> ${p.sale_discount}% <br>
              <strong>Purchase Tax:</strong> ${p.purchase_tax}% | <strong>Sale Tax:</strong> ${p.sale_tax}% <br>
            </p>
            <div class="d-flex">
              <button class="btn btn-warning btn-sm me-2 flex-fill" onclick="editProduct(${p.id})">‚úè Edit</button>
              <button class="btn btn-danger btn-sm flex-fill" onclick="deleteProduct(${p.id})">üóë Delete</button>
            </div>
          </div>
        </div>
      </div>`;
    });
    document.getElementById("productList").innerHTML = html || "<p class='text-center text-muted'>No products found</p>";
  }

  // ----------- ADD / UPDATE PRODUCT -----------
  document.getElementById("productForm").addEventListener("submit", async e => {
    e.preventDefault();
    const id = document.getElementById("productId").value;
    const vals = calculateFinals(); // get auto-calculated values

    const formData = new FormData();
    formData.append("hsn_code", document.getElementById("hsn_code").value);
    formData.append("name", document.getElementById("name").value);
    formData.append("size", document.getElementById("size").value);
    formData.append("pcs_size", document.getElementById("pcs_size").value);
    formData.append("mrp", document.getElementById("mrp").value);
    formData.append("sale_price", document.getElementById("sale_price").value);
    formData.append("sale_discount", document.getElementById("sale_discount").value);
    formData.append("sale_tax", document.getElementById("sale_tax").value);
    formData.append("purchase_price", document.getElementById("purchase_price").value);
    formData.append("purchase_discount", document.getElementById("purchase_discount").value);
    formData.append("purchase_tax", document.getElementById("purchase_tax").value);

    // append calculated values
    formData.append("purchase_discount_price", vals.purchaseDiscountPrice.toFixed(2));
    formData.append("purchase_tax_price", vals.purchaseTaxPrice.toFixed(2));
    formData.append("final_purchase_price", vals.finalPurchasePrice.toFixed(2));
    formData.append("sale_discount_price", vals.saleDiscountPrice.toFixed(2));
    formData.append("sale_tax_price", vals.saleTaxPrice.toFixed(2));
    formData.append("final_sale_price", vals.finalSalePrice.toFixed(2));

    const photoFile = document.getElementById("photo").files[0];
    if(photoFile) formData.append("photo", photoFile);

    let res;
    if(id) res = await fetch(API_URL + id + "/", { method: "PUT", body: formData });
    else res = await fetch(API_URL, { method: "POST", body: formData });

    if(res.ok){
      fetchProducts();
      document.getElementById("productForm").reset();
      document.getElementById("formTitle").innerText = "‚ûï Add Product";
      document.getElementById("productId").value = "";
      document.getElementById("productFormCard").style.display = "none";
    } else alert("Error saving product");
  });

  // ----------- EDIT PRODUCT -----------
  async function editProduct(id){
    const res = await fetch(API_URL + id + "/");
    const p = await res.json();
    document.getElementById("productId").value = p.id;
    document.getElementById("hsn_code").value = p.hsn_code || "";
    document.getElementById("name").value = p.name;
    document.getElementById("size").value = p.size || "";
    document.getElementById("pcs_size").value = p.pcs_size || "";
    document.getElementById("mrp").value = p.mrp;
    document.getElementById("sale_price").value = p.sale_price;
    document.getElementById("sale_discount").value = p.sale_discount;
    document.getElementById("sale_tax").value = p.sale_tax;
    document.getElementById("purchase_price").value = p.purchase_price;
    document.getElementById("purchase_discount").value = p.purchase_discount;
    document.getElementById("purchase_tax").value = p.purchase_tax;
    document.getElementById("formTitle").innerText = "‚úè Update Product";
    document.getElementById("productFormCard").style.display = "block";
  }

  // ----------- DELETE PRODUCT -----------
  async function deleteProduct(id){
    if(!confirm("Are you sure?")) return;
    const res = await fetch(API_URL + id + "/", { method: "DELETE" });
    if(res.ok) fetchProducts();
    else alert("Delete failed");
  }

  // ----------- FORM TOGGLE -----------
  document.getElementById("toggleFormBtn").addEventListener("click", ()=>{
    document.getElementById("productFormCard").style.display = "block";
  });

  document.getElementById("closeFormBtn").addEventListener("click", ()=>{
    document.getElementById("productFormCard").style.display = "none";
    document.getElementById("productForm").reset();
    document.getElementById("formTitle").innerText = "‚ûï Add Product";
    document.getElementById("productId").value = "";
  });

  // ----------- SEARCH -----------
  document.getElementById("searchInput").addEventListener("keyup", e=>{
    fetchProducts(e.target.value.trim());
  });

  // Initial load
  fetchProducts();
</script>
</body>
</html>



{% comment %} <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Product Management</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .card { border-radius: 12px; }
    .product-img { max-height: 80px; object-fit: cover; border-radius: 8px; }
    .mobile-form { max-width: 600px; margin: auto; display: none; }
    .form-label { font-size: 0.9rem; }
    .form-control { font-size: 0.9rem; padding: 6px 10px; }
    .card-title { font-size: 1rem; font-weight: 600; }
    .card-text { font-size: 0.85rem; line-height: 1.4; }
    .btn-sm { font-size: 0.8rem; padding: 4px 10px; }
  </style>
</head>
<body class="bg-light">

<div class="container py-3">

  <!-- Header -->
  <div class="text-center mb-3">
    <h2 class="fw-bold">üì¶ Product Management</h2>
  </div>

  <!-- Search + Add Button -->
  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
    <input type="text" id="searchInput" class="form-control" placeholder="üîç Search product..." style="max-width: 300px;">
    <button class="btn btn-success btn-sm" id="toggleFormBtn">‚ûï Add Product</button>
  </div>

  <!-- Product Form -->
  <div class="card shadow-sm mb-4 mobile-form" id="productFormCard">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 id="formTitle">Add Product</h5>
        <button class="btn btn-sm btn-outline-secondary" id="closeFormBtn">‚úñ</button>
      </div>

      <form id="productForm">
        <input type="hidden" id="productId">

        <div class="row g-2">
          <div class="col-md-6">
            <label class="form-label">HSN Code</label>
            <input type="text" id="hsn_code" class="form-control">
          </div>
          <div class="col-md-6">
            <label class="form-label">Name</label>
            <input type="text" id="name" class="form-control" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Size</label>
            <input type="text" id="size" class="form-control">
          </div>
          <div class="col-md-6">
            <label class="form-label">PCS Size</label>
            <input type="text" id="pcs_size" class="form-control">
          </div>

          <div class="col-md-6">
            <label class="form-label">MRP</label>
            <input type="number" id="mrp" class="form-control">
          </div>

          <div class="col-md-6">
            <label class="form-label">Purchase Price</label>
            <input type="number" id="purchase_price" class="form-control">
          </div>
          <div class="col-md-6">
            <label class="form-label">Purchase Discount</label>
            <input type="number" id="purchase_discount" class="form-control">
          </div>
          <div class="col-md-6">
            <label class="form-label">Purchase Tax</label>
            <input type="number" id="purchase_tax" class="form-control">
          </div>
          <div class="col-md-6">
            <label class="form-label">Sale Price</label>
            <input type="number" id="sale_price" class="form-control">
          </div>
          <div class="col-md-6">
            <label class="form-label">Sale Discount</label>
            <input type="number" id="sale_discount" class="form-control">
          </div>
          <div class="col-md-6">
            <label class="form-label">Sale Tax</label>
            <input type="number" id="sale_tax" class="form-control">
          </div>

          <div class="col-md-12">
            <label class="form-label">Photo</label>
            <input type="file" id="photo" class="form-control">
          </div>
        </div>

        <button type="submit" class="btn btn-primary w-100 mt-3">Save</button>
      </form>
    </div>
  </div>

  <!-- Product List -->
  <div class="row" id="productList"></div>

</div>

<!-- Bootstrap + JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const API_URL = "/api/products/";

  // Fetch and display products
  async function fetchProducts(query = "") {
    let url = API_URL;
    if (query) url += "?search=" + encodeURIComponent(query);
    const res = await fetch(url);
    const products = await res.json();
    let html = "";
    products.forEach(p => {
      html += `
        <div class="col-md-4 col-12 mb-3">
          <div class="card shadow-sm h-100">
            ${p.photo ? `<img src="${p.photo}" class="card-img-top product-img" alt="${p.name}">` : ""}
            <div class="card-body">
              <h5 class="card-title">${p.name}</h5>
              <p class="card-text">
                <strong>HSN:</strong> ${p.hsn_code || "-"} <br>
                <strong>Size:</strong> ${p.size || "-"} | <strong>PCS:</strong> ${p.pcs_size || "-"} <br>
                <strong>MRP:</strong> ${p.mrp} <br>
                <strong>Purchase:</strong> ${p.purchase_price} | <strong>Sale:</strong> ${p.sale_price} <br> 
                <strong>Purchase Disc:</strong> ${p.purchase_discount}% | <strong>Sale Disc:</strong> ${p.sale_discount}% <br>
                <strong>Purchase Tax:</strong> ${p.purchase_tax}% | <strong>Sale Tax:</strong> ${p.sale_tax}% <br>
              </p>
              <div class="d-flex">
                <button class="btn btn-warning btn-sm me-2 flex-fill" onclick="editProduct(${p.id})">‚úè Edit</button>
                <button class="btn btn-danger btn-sm flex-fill" onclick="deleteProduct(${p.id})">üóë Delete</button>
              </div>
            </div>
          </div>
        </div>`;
    });
    document.getElementById("productList").innerHTML = html || "<p class='text-center text-muted'>No products found</p>";
  }

  // Add or Update product
  document.getElementById("productForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const id = document.getElementById("productId").value;

    const formData = new FormData();
    formData.append("hsn_code", document.getElementById("hsn_code").value);
    formData.append("name", document.getElementById("name").value);
    formData.append("size", document.getElementById("size").value);
    formData.append("pcs_size", document.getElementById("pcs_size").value);
    formData.append("mrp", document.getElementById("mrp").value);
    formData.append("sale_price", document.getElementById("sale_price").value);
    formData.append("sale_discount", document.getElementById("sale_discount").value);
    formData.append("sale_tax", document.getElementById("sale_tax").value);
    formData.append("purchase_price", document.getElementById("purchase_price").value);
    formData.append("purchase_discount", document.getElementById("purchase_discount").value);
    formData.append("purchase_tax", document.getElementById("purchase_tax").value);

    const photoFile = document.getElementById("photo").files[0];
    if (photoFile) formData.append("photo", photoFile);

    let res;
    if (id) {
      res = await fetch(API_URL + id + "/", {
        method: "PUT",
        body: formData
      });
    } else {
      res = await fetch(API_URL, {
        method: "POST",
        body: formData
      });
    }

    if (res.ok) {
      fetchProducts();
      document.getElementById("productForm").reset();
      document.getElementById("formTitle").innerText = "‚ûï Add Product";
      document.getElementById("productId").value = "";
      document.getElementById("productFormCard").style.display = "none"; // hide after save
    } else {
      alert("Error saving product");
    }
  });

  // Edit product
  async function editProduct(id) {
    const res = await fetch(API_URL + id + "/");
    const p = await res.json();
    document.getElementById("productId").value = p.id;
    document.getElementById("hsn_code").value = p.hsn_code || "";
    document.getElementById("name").value = p.name;
    document.getElementById("size").value = p.size || "";
    document.getElementById("pcs_size").value = p.pcs_size || "";
    document.getElementById("mrp").value = p.mrp;
    document.getElementById("sale_price").value = p.sale_price;
    document.getElementById("sale_discount").value = p.sale_discount;
    document.getElementById("sale_tax").value = p.sale_tax;
    document.getElementById("purchase_price").value = p.purchase_price;
    document.getElementById("purchase_discount").value = p.purchase_discount;
    document.getElementById("purchase_tax").value = p.purchase_tax;
    document.getElementById("formTitle").innerText = "‚úè Update Product";
    document.getElementById("productFormCard").style.display = "block";
  }

  // Delete product
  async function deleteProduct(id) {
    if (!confirm("Are you sure?")) return;
    const res = await fetch(API_URL + id + "/", { method: "DELETE" });
    if (res.ok) fetchProducts();
    else alert("Delete failed");
  }

  // Toggle form
  document.getElementById("toggleFormBtn").addEventListener("click", () => {
    document.getElementById("productFormCard").style.display = "block";
  });

  document.getElementById("closeFormBtn").addEventListener("click", () => {
    document.getElementById("productFormCard").style.display = "none";
    document.getElementById("productForm").reset();
    document.getElementById("formTitle").innerText = "‚ûï Add Product";
    document.getElementById("productId").value = "";
  });

  // Search products
  document.getElementById("searchInput").addEventListener("keyup", (e) => {
    const query = e.target.value.trim();
    fetchProducts(query);
  });

  // Load products initially
  fetchProducts();
</script>
</body>
</html> {% endcomment %}
