{% extends layout_path %}
{% load static %}
{% block title %} Purchases {% endblock %}

{% block content %}
<div class="d-flex justify-content-end align-items-center mb-3 gap-2">
  {% comment %} <button type="button" class="btn btn-outline-success" id="exportPurchaseExcelBtn" disabled>
    <i class="bx bx-file"></i> Export
  </button> {% endcomment %}
  <!-- Search box -->
  <div class="flex-grow-1">
    <input type="text" id="searchBox" class="form-control" placeholder="Search purchases...">
  </div>
  <a href="/purchase/add/" class="btn btn-primary">
    <i class="bx bx-plus"></i> Add Purchase
  </a>
</div>

<div class="card">
  <div class="table-responsive text-nowrap">
    <table class="table table-hover">
      <thead>
        <tr>
          <th>Variant</th>
          <th>Quantity</th>
          <th>Purchase Price</th>
          <th>Discount %</th>
          <th>Discount Price</th>
          <th>GST %</th>
          <th>Total Price</th>
          <th>Supplier</th>
          <th>Date</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="purchases-table-body">
        <tr id="purchases-loader-row">
          <td colspan="9" class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Deletion</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">Are you sure you want to delete this purchase?</div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
      </div>
    </div>
  </div>
</div>

<script>
let deletePurchaseId = null;

function delete_purchase(id) {
  deletePurchaseId = id;
  const modal = new bootstrap.Modal(document.getElementById("deleteConfirmModal"));
  modal.show();
}

function showToast(title, message, status) {
  const toast = document.getElementById("alert-box");
  document.getElementById("toast-title").textContent = title;
  document.getElementById("toast-body").textContent = message;
  document.getElementById("toast-icon").className = `bx me-2 ${status === "success" ? "bx-check-circle" : "bx-error"}`;
  toast.className = `bs-toast toast bg-${status} toast-placement-ex top-0 end-0 m-2 show`;
  new bootstrap.Toast(toast).show();
}

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
      cookie = cookie.trim();
      if (cookie.startsWith(name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

function loadPurchases(search = "") {
  const tbody = document.getElementById("purchases-table-body");

  tbody.innerHTML = "";

  let url = "/admin_api/purchases/";
  if (search) {
    url += `?search=${encodeURIComponent(search)}`;
  }

  fetch(url)
    .then(res => res.json())
    .then(data => {
      tbody.innerHTML = "";

      // handle pagination (if enabled in DRF)
      const results = data.results || data;

      results.forEach(p => {
        const row = `
          <tr>
            <td><a href="/purchase/detail/${p.id}/">${p.product_name || ""}</a></td>
            <td>${p.quantity}</td>
            <td>${p.purchase_price}</td>
            <td>${p.discount || 0}</td>
            <td>${p.discount_price || 0}</td>
            <td>${p.gst || 0}</td>
            <td>${p.total_price}</td>
            <td><a href="/supplier/detail/${p.supplier}/">${p.supplier_name || ""}</a></td>
            <td>${p.date}</td>
            <td>
              <div class="dropdown">
                <button type="button" class="btn p-0 dropdown-toggle hide-arrow" data-bs-toggle="dropdown">
                  <i class="bx bx-dots-vertical-rounded"></i>
                </button>
                <div class="dropdown-menu">
                  <a class="dropdown-item text-info" href="/purchase/edit/${p.id}/">
                    <i class="bx bx-edit-alt me-1"></i> Edit
                  </a>
                  <a class="dropdown-item text-danger" href="javascript:void(0);" onclick="delete_purchase(${p.id})">
                    <i class="bx bx-trash me-1"></i> Delete
                  </a>
                </div>
              </div>
            </td>
          </tr>
        `;
        tbody.insertAdjacentHTML("beforeend", row);
      });

      const totalRow = `
        <tr>
          <td colspan="10" class="text-end fw-bold text-primary">
            Total Records: ${results.length}
          </td>
        </tr>
      `;
      tbody.insertAdjacentHTML("beforeend", totalRow);
    })
    .catch(err => {
      console.error("Error loading purchases:", err);
    });
}


// ðŸ”Ž Search handler
document.addEventListener("DOMContentLoaded", () => {
  const searchBox = document.getElementById("searchBox");

  function triggerSearch() {
    loadPurchases(searchBox.value.trim());
  }

  // Debounce for typing
  let searchTimeout = null;
  searchBox.addEventListener("input", () => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(triggerSearch, 400);
  });

  // Press Enter to search immediately
  searchBox.addEventListener("keypress", (e) => {
    if (e.key === "Enter") triggerSearch();
  });

  // Initial load
  loadPurchases();
});


document.getElementById("confirmDeleteBtn").addEventListener("click", () => {
  if (!deletePurchaseId) return;

  fetch(`/admin_api/purchases/${deletePurchaseId}/`, {
    method: "DELETE",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": getCookie("csrftoken")
    }
  })
    .then(res => {
      if (res.ok) {
        location.reload();
      } else {
        showToast("Error", "Failed to delete purchase", "danger");
      }
    })
    .catch(err => console.error("Delete error:", err));
});
</script>
{% endblock %}
