{% extends layout_path %}
{% load static %}
{% block title %} Customers {% endblock %}

{% block content %}
<div class="d-flex justify-content-end align-items-center mb-3 gap-2">
  {% comment %} <button type="button" class="btn btn-outline-success" id="exportCustomerExcelBtn" disabled>
    <i class="bx bx-file"></i> Export
  </button> {% endcomment %}
  <div class="flex-grow-1">
    <input type="text" id="searchBox" class="form-control" placeholder="Search customers...">
  </div>
  <a href="/customer/add/" class="btn btn-primary">
    <i class="bx bx-plus"></i> Add Customer
  </a>
</div>

<div class="card">
  <div class="table-responsive text-nowrap" id="customer-scroll" style="max-height: 500px; overflow-y: auto;">
    <table class="table table-hover">
      <thead>
        <tr>
          <th>Name</th>
          <th>Phone</th>
          <th>Pending Amount</th>
          <th>Advance Payment</th>
          <th>Email</th>
          <th>Address</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="customers-table-body">
        <tr id="customers-loader-row">
          <td colspan="5" class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Deletion</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">Are you sure you want to delete this customer?</div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
      </div>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="bs-toast toast toast-placement-ex m-2" id="alert-box" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="2000">
  <div class="toast-header">
    <i class="bx bx-bell me-2" id="toast-icon"></i>
    <div class="me-auto fw-medium" id="toast-title">Notification</div>
    <small class="toast-time">Now</small>
    <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
  </div>
  <div class="toast-body" id="toast-body"></div>
</div>

<!-- Payment Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" style="color: white;">Add Payment</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="paymentForm">
          <input type="hidden" id="customerId">
          <div class="mb-3">
            <label class="form-label">Customer</label>
            <input type="text" id="customerName" class="form-control" readonly>
          </div>
          <div class="mb-3">
            <label class="form-label">Payment Amount (₹)</label>
            <input type="number" id="paymentAmount" class="form-control" step="0.01" min="0" required>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" onclick="submitPayment()">Save</button>
      </div>
    </div>
  </div>
</div>

<script>
let deleteCustomerId = null;
let page = 1;
let nextPage = null;
let isLoading = false;
let totalRecords = 0;
let currentSearch = "";

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
      cookie = cookie.trim();
      if (cookie.startsWith(name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

function delete_customer(id) {
  deleteCustomerId = id;
  new bootstrap.Modal(document.getElementById("deleteConfirmModal")).show();
}

document.getElementById("confirmDeleteBtn").addEventListener("click", () => {
  if (!deleteCustomerId) return;
  fetch(`/admin_api/customers/${deleteCustomerId}/`, {
    method: "DELETE",
    headers: { "X-CSRFToken": getCookie("csrftoken") }
  }).then(res => {
    if (res.ok) location.reload();
    else alert("Failed to delete customer");
  });
});

// ✅ Function to load customer data
function loadCustomers(initialLoad = false) {
  const tbody = document.getElementById("customers-table-body");
  const loader = document.getElementById("customers-loader-row");

  if (!tbody) return; // safety check
  if (isLoading) return;
  isLoading = true;
  if (loader) loader.style.display = "";

  let url = `/admin_api/customers/?page=${page}`;
  if (currentSearch) url += `&search=${encodeURIComponent(currentSearch)}`;

  fetch(url)
    .then(res => res.json())
    .then(data => {
      const results = data.results || data;
      if (loader) loader.style.display = "none";
      isLoading = false;
      nextPage = data.next;

      if (initialLoad) {
        tbody.innerHTML = "";
        totalRecords = 0;
      }

      results.forEach(c => {
        totalRecords++;
        const row = `
          <tr>
            <td><a href="/customer/detail/${c.id}/">${c.name || ""}</a></td>
            <td>${c.phone || ""}</td>
            <td>₹${c.pending_amount || "0.00"}</td>
            <td>₹${c.advance_payment || "0.00"}</td>
            <td>${c.email || ""}</td>
            <td>${c.address || ""}</td>
            <td>
              <div class="dropdown">
                <button type="button" class="btn p-0 dropdown-toggle hide-arrow" data-bs-toggle="dropdown">
                  <i class="bx bx-dots-vertical-rounded"></i>
                </button>
                <div class="dropdown-menu">
                  <a class="dropdown-item text-primary" href="/customer-orders/${c.id}/">
                    <i class="bx bx-receipt me-1"></i> Bills
                  </a>
                  <a class="dropdown-item text-success" href="javascript:void(0);" onclick="openPaymentModal(${c.id}, '${c.name}')">
                    <i class="bx bx-rupee me-1"></i> Payment
                  </a>
                  <a class="dropdown-item text-info" href="/customer/edit/${c.id}/">
                    <i class="bx bx-edit-alt me-1"></i> Edit
                  </a>
                  <a class="dropdown-item text-danger" href="javascript:void(0);" onclick="delete_customer(${c.id})">
                    <i class="bx bx-trash me-1"></i> Delete
                  </a>
                </div>
              </div>
            </td>
          </tr>`;
        tbody.insertAdjacentHTML("beforeend", row);
      });

      // Update total row
      const totalRow = document.getElementById("customers-total-row");
      if (totalRow) totalRow.remove();
      tbody.insertAdjacentHTML("beforeend", `
        <tr id="customers-total-row">
          <td colspan="7" class="text-end fw-bold text-primary">
            Total Records: ${totalRecords}
          </td>
        </tr>
      `);
    })
    .catch(err => {
      loader.style.display = "none";
      isLoading = false;
      console.error("Error loading customers:", err);
    });
}

// ✅ Initialize all when page loads
document.addEventListener("DOMContentLoaded", () => {
  const scrollBox = document.getElementById("customer-scroll");
  const searchBox = document.getElementById("searchBox");

  let searchTimeout = null;
  searchBox.addEventListener("input", () => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        currentSearch = searchBox.value.trim();
        page = 1;
        nextPage = null;
        loadCustomers(true);
      }, 400);
    });
  
  scrollBox.addEventListener("scroll", () => {
    if (
      scrollBox.scrollTop + scrollBox.clientHeight >= scrollBox.scrollHeight - 50 &&
      nextPage && !isLoading
      ) {
        page++;
        loadCustomers();
      }
    });   
    
    loadCustomers(true);
});

function openPaymentModal(id, name) {
  document.getElementById('customerId').value = id;
  document.getElementById('customerName').value = name;
  document.getElementById('paymentAmount').value = '';
  new bootstrap.Modal(document.getElementById('paymentModal')).show();
}

function submitPayment() {
  const id = document.getElementById('customerId').value;
  const amount = parseFloat(document.getElementById('paymentAmount').value);

  if (isNaN(amount) || amount <= 0) {
    alert("Please enter a valid payment amount.");
    return;
  }

  fetch(`/admin_api/customers/${id}/payment/`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": getCookie('csrftoken')
    },
    body: JSON.stringify({ payment_amount: amount })
  })
  .then(res => res.json())
  .then(data => {
    if (data.status) {
      alert("Payment updated successfully!");
      location.reload();
    } else {
      alert("Error: " + data.message);
    }
  });
}
</script>


{% endblock %}
