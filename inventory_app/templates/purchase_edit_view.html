{% extends layout_path %}
{% load static %}
{% block title %}Manage Purchase{% endblock %}

{% block content %}
<div class="row">
  <div class="col-xxl">
    <div class="card mb-6">
      <div class="card-header d-flex align-items-center justify-content-between">
        <h5 class="mb-0">Add Purchase</h5>
      </div>
      <div class="card-body">

        <!-- Loader -->
        <div id="form-loader" class="text-center my-4" style="display: none;">
          <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
        </div>

        <!-- Toast -->
        <div class="bs-toast toast toast-placement-ex m-2" id="alert-box" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="2000">
          <div class="toast-header">
            <i class="bx bx-bell me-2" id="toast-icon"></i>
            <div class="me-auto fw-medium" id="toast-title">Notification</div>
            <small class="toast-time">Now</small>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
          </div>
          <div class="toast-body" id="toast-body"></div>
        </div>

        <!-- Form -->
        <form id="purchase-form" style="display: none;">
          {% csrf_token %}

          <div class="row mb-4">
            <label class="col-sm-2 col-form-label" for="supplier">Supplier</label>
            <div class="col-sm-10">
              <select id="supplier" class="form-control"></select>
            </div>
          </div>

          <div class="row mb-4">
            <label class="col-sm-2 col-form-label" for="variant">Product Variant</label>
            <div class="col-sm-10">
              <select id="variant" class="form-control"></select>
            </div>
          </div>

          <div class="row mb-4">
            <label class="col-sm-2 col-form-label" for="quantity">Quantity</label>
            <div class="col-sm-10">
              <input type="number" id="quantity" class="form-control" required min="1" value="1" />
            </div>
          </div>

          <div class="row mb-4">
            <label class="col-sm-2 col-form-label" for="purchase_price">Purchase Price (per item)</label>
            <div class="col-sm-10">
              <input type="number" step="0.01" id="purchase_price" class="form-control" required />
            </div>
          </div>

          <div class="row mb-4">
            <label class="col-sm-2 col-form-label" for="discount">Discount %</label>
            <div class="col-sm-10">
              <input type="number" step="0.01" id="discount" class="form-control" value="0" />
            </div>
          </div>

          <div class="row mb-4">
            <label class="col-sm-2 col-form-label" for="gst">GST %</label>
            <div class="col-sm-10">
              <input type="number" step="0.01" id="gst" class="form-control" value="0" />
            </div>
          </div>

          <div class="row mb-4">
            <label class="col-sm-2 col-form-label" for="total_price">Total Price</label>
            <div class="col-sm-10">
              <input type="number" id="total_price" class="form-control" readonly />
            </div>
          </div>

          <!-- Buttons -->
          <div class="btn-container-save">
            <div class="row justify-content-end">
              <div class="col-sm-12">
                {% if view_only == 'false' %}
                  <button type="submit" class="btn btn-primary" id="submit-button">Add Purchase</button>
                {% endif %}
                <button type="button" class="btn btn-secondary" id="back-button" onclick="window.location.href='/purchase-list/'">Back</button>
              </div>
            </div>
          </div>
        </form>

      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block page_js %}
<script>
  const form = document.getElementById("purchase-form");
  const loader = document.getElementById("form-loader");
  const purchaseId = "{{ id|default:'' }}";
  const isView = "{{ view_only|default:'false' }}" === 'true';
  const isEdit = Boolean(purchaseId) && !isView;

  document.addEventListener("DOMContentLoaded", () => {
    console.log("DOM loaded. purchaseId:", purchaseId, "isView:", isView, "isEdit:", isEdit);
    
    const submitBtn = document.getElementById("submit-button");
    const formHeading = document.querySelector(".card-header h5");

    if (isView) {
      formHeading.textContent = "View Purchase";
      document.title = "View Purchase";
      if (submitBtn) submitBtn.style.display = "none";
    } else if (isEdit) {
      formHeading.textContent = "Edit Purchase";
      document.title = "Edit Purchase";
      if (submitBtn) submitBtn.textContent = "Update Purchase";
    } else {
      formHeading.textContent = "Add Purchase";
      document.title = "Add Purchase";
    }

    // wait for dropdowns to load before setting values
    console.log("Loading dropdowns...");
    loadDropdowns().then(() => {
      console.log("Dropdowns loaded successfully");
      if (isEdit || isView) {
        console.log("Loading purchase data for edit/view mode");
        loadPurchase(purchaseId);
      } else {
        console.log("Showing form for add mode");
        form.style.display = "block";
      }
    }).catch(err => {
      console.error("Failed to load dropdowns:", err);
      // Show form anyway
      form.style.display = "block";
    });

    ["quantity", "purchase_price", "discount", "gst"].forEach(id => {
      document.getElementById(id).addEventListener("input", calculateTotal);
    });
  });

  // Function to fetch all variants across all pages
  async function fetchAllVariants() {
    let allVariants = [];
    let page = 1;
    let hasMorePages = true;
    
    while (hasMorePages) {
      try {
        const response = await fetch(`/admin_api/product-variants/?page=${page}`);
        if (!response.ok) throw new Error(`Variants API error: ${response.status}`);
        
        const data = await response.json();
        console.log(`Variants page ${page}:`, data);
        
        // Handle paginated response
        const variants = data.rows || data.results || data;
        if (Array.isArray(variants)) {
          allVariants = allVariants.concat(variants);
        }
        
        // Check if there are more pages
        hasMorePages = data.next !== null;
        page++;
        
        // Safety check to avoid infinite loops
        if (page > 10) {
          console.warn("Too many pages, stopping at page 10");
          break;
        }
      } catch (error) {
        console.error("Error fetching variants page", page, ":", error);
        hasMorePages = false;
      }
    }
    
    return allVariants;
  }

  function loadDropdowns() {
    console.log("Starting to load dropdowns...");
    return Promise.all([
      fetch("/admin_api/suppliers/?page_size=1000")
        .then(r => {
          console.log("Suppliers API response status:", r.status);
          if (!r.ok) throw new Error(`Suppliers API error: ${r.status}`);
          return r.json();
        })
        .then(data => {
          console.log("Suppliers data:", data);
          let supplierSelect = document.getElementById("supplier");
          supplierSelect.innerHTML = `<option value="">-- Select Supplier --</option>`;
          
          // Handle both paginated and direct array responses
          const suppliers = data.rows || data.results || data;
          if (Array.isArray(suppliers)) {
            suppliers.forEach(s => {
              supplierSelect.innerHTML += `<option value="${s.id}">${s.name}</option>`;
            });
            console.log("Suppliers dropdown populated with", suppliers.length, "items");
          } else {
            console.error("Suppliers data is not an array:", suppliers);
          }
        }),

      // Load ALL variants (not paginated) for the dropdown
      fetchAllVariants()
        .then(variants => {
          console.log("All variants loaded:", variants.length);
          let variantSelect = document.getElementById("variant");
          variantSelect.innerHTML = `<option value="">-- Select Product Variant --</option>`;
          variants.forEach(variant => {
            variantSelect.innerHTML += `<option value="${variant.id}">${variant.product_name} - ${variant.size}</option>`;
          });
          console.log("Variants dropdown populated with", variants.length, "items");
        }),
    ]);
  }

  function calculateTotal() {
    const qty = parseFloat(document.getElementById("quantity").value) || 0;
    const price = parseFloat(document.getElementById("purchase_price").value) || 0;
    const discount = parseFloat(document.getElementById("discount").value) || 0;
    const gst = parseFloat(document.getElementById("gst").value) || 0;

    const priceAfterDiscount = price - (price * discount / 100);
    const gstAmount = priceAfterDiscount * gst / 100;
    const total = (priceAfterDiscount + gstAmount) * qty;

    document.getElementById("total_price").value = total.toFixed(2);
  }

  function loadPurchase(id) {
    console.log("Loading purchase with ID:", id);
    fetch(`/admin_api/purchases/${id}/`)
      .then(res => {
        console.log("Response status:", res.status);
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        return res.json();
      })
      .then(data => {
        console.log("Purchase data loaded:", data);
        
        // Check if elements exist and set values
        const supplierSelect = document.getElementById("supplier");
        const variantSelect = document.getElementById("variant");
        const quantityInput = document.getElementById("quantity");
        const priceInput = document.getElementById("purchase_price");
        const discountInput = document.getElementById("discount");
        const gstInput = document.getElementById("gst");
        
        if (supplierSelect) {
          supplierSelect.value = data.supplier || '';
          console.log("Supplier set to:", data.supplier);
        }
        
        if (variantSelect) {
          variantSelect.value = data.variant || '';
          console.log("Variant set to:", data.variant);
        }
        
        if (quantityInput) {
          quantityInput.value = data.quantity || '';
          console.log("Quantity set to:", data.quantity);
        }
        
        if (priceInput) {
          priceInput.value = data.purchase_price || '';
          console.log("Purchase price set to:", data.purchase_price);
        }
        
        if (discountInput) {
          discountInput.value = data.discount || 0;
          console.log("Discount set to:", data.discount);
        }
        
        if (gstInput) {
          gstInput.value = data.gst || 0;
          console.log("GST set to:", data.gst);
        }
        
        calculateTotal();

        if (isView) {
          form.querySelectorAll("input, select, button").forEach(el => {
            if (el.id !== "back-button") el.disabled = true;
          });
        } else if (isEdit) {
          // In edit mode, make variant field read-only (not changeable)
          if (variantSelect) {
            variantSelect.disabled = true;
            variantSelect.style.backgroundColor = "#f8f9fa";
            variantSelect.style.cursor = "not-allowed";
            console.log("Variant field set to read-only for edit mode");
          }
        }
        form.style.display = "block";
        console.log("Form displayed successfully with all values set");
      })
      .catch(err => {
        console.error("Failed to load purchase:", err);
        showToast("Error", "Failed to load data: " + err.message, "danger");
        // Show form anyway so user can see there's an issue
        form.style.display = "block";
      });
  }

  form.addEventListener("submit", function (e) {
    e.preventDefault();
    if (isView) return;

    loader.style.display = "block";
    form.style.display = "none";

    const payload = {
      supplier: document.getElementById("supplier").value,
      quantity: document.getElementById("quantity").value,
      purchase_price: document.getElementById("purchase_price").value,
      discount: document.getElementById("discount").value,
      gst: document.getElementById("gst").value,
      total_price: document.getElementById("total_price").value
    };

    // Only include variant in payload for new purchases, not for edits
    if (!isEdit) {
      payload.variant = document.getElementById("variant").value;
    }

    const url = isEdit
      ? `/admin_api/purchases/${purchaseId}/`
      : `/admin_api/purchases/`;
    const method = isEdit ? "PATCH" : "POST";

    fetch(url, {
      method: method,
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCookie("csrftoken")
      },
      body: JSON.stringify(payload)
    })
      .then(res => {
        loader.style.display = "none";
        if (res.ok) {
          showToast("Success", `Purchase ${isEdit ? "updated" : "added"} successfully`, "success");
          setTimeout(() => window.location.href = "/purchase-list/", 1500);
        } else {
          res.json().then(data => {
            form.style.display = "block";
            const error = data?.detail || "Operation failed.";
            showToast("Error", error, "danger");
          });
        }
      })
      .catch(err => {
        loader.style.display = "none";
        form.style.display = "block";
        showToast("Error", "Something went wrong.", "danger");
      });
  });

  function showToast(title, message, status) {
    const toast = document.getElementById("alert-box");
    document.getElementById("toast-title").textContent = title;
    document.getElementById("toast-body").textContent = message;
    document.getElementById("toast-icon").className = `bx me-2 ${status === "success" ? "bx-check-circle" : "bx-error"}`;
    toast.className = `bs-toast toast bg-${status} toast-placement-ex top-0 end-0 m-2 show`;
    new bootstrap.Toast(toast).show();
  }

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
</script>
{% endblock %}
