{% extends layout_path %}
{% load static %}
{% block title %}Sales Report{% endblock %}

{% block content %}
<div class="d-flex justify-content-end align-items-center mb-3 gap-2">
  <div class="flex-grow-1">
    <input type="text" id="searchBox" class="form-control" placeholder="Search categories...">
  </div>
</div>
<div class="card">

  <!-- ðŸ”¹ Date Filter Card -->
  <div class="card mb-4 shadow-sm">
    <div class="card-body">
      <form id="filterForm" class="row g-3 align-items-end">
        <div class="col-md-4">
          <label for="startDate" class="form-label">Start Date</label>
          <input type="date" id="startDate" class="form-control">
        </div>
        <div class="col-md-4">
          <label for="endDate" class="form-label">End Date</label>
          <input type="date" id="endDate" class="form-control">
        </div>
        <div class="col-md-4 d-flex gap-2">
          <button type="submit" class="btn btn-primary flex-grow-1" id="applyFilterBtn">
            <i class="bx bx-filter-alt"></i> Apply Filter
          </button>
          <button type="button" class="btn btn-secondary flex-grow-1" id="resetFilterBtn">
            <i class="bx bx-reset"></i> Reset Filter
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- ðŸ”¹ Sales Table -->
  <div class="table-responsive text-nowrap" style="max-height: 80vh; overflow-y: auto;" id="sales-scroll">
    <table class="table table-hover">
      <thead>
        <tr>
          <th>Date</th>
          <th>Order ID</th>
          <th>Customer</th>
          <th>Payment Type</th>
          <th>Total Amount</th>
          <th>Paid Amount</th>
          <th>Profit</th>
        </tr>
      </thead>
      <tbody id="sales-table-body">
        <tr id="sales-loader-row">
          <td colspan="7" class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </td>
        </tr>
      </tbody>
      <tfoot>
        <tr class="table-light fw-bold" id="total-row">
          <td colspan="4" class="text-end text-primary">Totals:</td>
          <td id="total-sales">0.00</td>
          <td id="total-paid">0.00</td>
          <td id="total-profit">0.00</td>
        </tr>
      </tfoot>
    </table>
  </div>

</div>
{% endblock %}

{% block page_js %}
<script>
  let page = 1;
  let nextPage = null;
  let isLoading = false;
  let filters = { start: "", end: "" };
  let searchQuery = "";

  let totalSales = 0;
  let totalPaid = 0;
  let totalProfit = 0;

  let tbody, loader, scrollBox, searchBox, startInput, endInput, resetBtn;
  let totalSalesEl, totalPaidEl, totalProfitEl;

  // ðŸ”¹ Update Totals
  function updateTotals() {
    totalSalesEl.textContent = totalSales.toFixed(2);
    totalPaidEl.textContent = totalPaid.toFixed(2);
    totalProfitEl.textContent = totalProfit.toFixed(2);
  }

  // ðŸ”¹ Build API URL
  function buildURL(page = 1) {
    let url = `/admin_api/sales/?page=${page}`;
    if (filters.start && filters.end) {
      url += `&start_date=${filters.start}&end_date=${filters.end}`;
    }
    if (searchQuery) {
      url += `&search=${encodeURIComponent(searchQuery)}`;
    }
    return url;
  }

  // ðŸ”¹ Fetch Sales Data
  function fetchSales(initial = false) {
    if (isLoading) return;
    isLoading = true;
    loader.style.display = "";

    fetch(buildURL(page))
      .then(res => res.json())
      .then(data => {
        loader.style.display = "none";
        isLoading = false;
        nextPage = data.next;

        const results = data.results || data;
        if (initial) {
          tbody.innerHTML = "";
          totalSales = totalPaid = totalProfit = 0;
        }

        if (!results.length && initial) {
          tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted py-4">No sales found.</td></tr>`;
          updateTotals();
          return;
        }

        results.forEach(sale => {
          totalSales += parseFloat(sale.total_amount || 0);
          totalPaid += parseFloat(sale.paid_amount || 0);
          totalProfit += parseFloat(sale.profit || 0);

          const row = `
            <tr>
              <td>${sale.sale_date || ""}</td>
              <td>${sale.order_id || ""}</td>
              <td>${sale.customer_name || "Walk-in"}</td>
              <td>${sale.pay_type || ""}</td>
              <td>${sale.total_amount || "0.00"}</td>
              <td>${sale.paid_amount || "0.00"}</td>
              <td>${sale.profit || "0.00"}</td>
            </tr>`;
          tbody.insertAdjacentHTML("beforeend", row);
        });

        updateTotals();
      })
      .catch(err => {
        loader.style.display = "none";
        isLoading = false;
        console.error("Error loading sales:", err);
      });
  }

  // ðŸ”¹ Initialize DOM
  document.addEventListener("DOMContentLoaded", () => {
    tbody = document.getElementById("sales-table-body");
    loader = document.getElementById("sales-loader-row");
    scrollBox = document.getElementById("sales-scroll");
    searchBox = document.getElementById("searchBox");
    startInput = document.getElementById("startDate");
    endInput = document.getElementById("endDate");
    resetBtn = document.getElementById("resetFilterBtn");

    totalSalesEl = document.getElementById("total-sales");
    totalPaidEl = document.getElementById("total-paid");
    totalProfitEl = document.getElementById("total-profit");

    // ðŸ”¹ Initial Load
    fetchSales(true);

    // ðŸ”¹ Infinite Scroll
    scrollBox.addEventListener("scroll", () => {
      if (scrollBox.scrollTop + scrollBox.clientHeight >= scrollBox.scrollHeight - 50 && nextPage && !isLoading) {
        page++;
        fetchSales();
      }
    });

    // ðŸ”¹ Search
    let searchTimeout = null;
    searchBox.addEventListener("input", () => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        searchQuery = searchBox.value.trim();
        page = 1;
        nextPage = null;
        fetchSales(true);
      }, 400);
    });

    // ðŸ”¹ Date Filter
    document.getElementById("filterForm").addEventListener("submit", e => {
      e.preventDefault();
      start = startInput.value;
      end = endInput.value;
      if (start && !end) {
        const today = new Date().toISOString().split("T")[0];
        endInput.value = today;
        end = today;
      }
      filters = { start, end };
      page = 1;
      nextPage = null;
      fetchSales(true);
    });

    // ðŸ”¹ Reset Filter
    resetBtn.addEventListener("click", () => {
      startInput.value = "";
      endInput.value = "";
      filters = { start: "", end: "" };
      searchBox.value = "";
      searchQuery = "";
      page = 1;
      nextPage = null;
      fetchSales(true);
    });
  });

  // Auto-open date picker
  [document.getElementById("startDate"), document.getElementById("endDate")].forEach(input => {
    input.addEventListener("focus", () => {
      if (input.showPicker) input.showPicker();
    });
  });
</script>
{% endblock %}

