{% extends layout_path %}
{% block title %}Supplier Purchases{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
  <h4 class="fw-bold mb-2 mb-md-0">Purchases for Supplier</h4>
  <div class="d-flex justify-content-end align-items-center gap-2 flex-wrap">
    <button type="button" class="btn btn-outline-danger" id="exportPdfBtn">
      <i class="bx bxs-file-pdf"></i> Export PDF
    </button>
    <button type="button" class="btn btn-outline-success" id="printPdfBtn">
      <i class="bx bx-printer"></i> Print Bill
    </button>
    <a href="/supplier-list/" class="btn btn-primary">
      <i class="bx bx-arrow-back"></i> Back to Suppliers
    </a>
  </div>
</div>

<!-- ðŸ”¹ Date Filter -->
<div class="card mb-4 shadow-sm">
  <div class="card-body">
    <form id="filterForm" class="row g-3 align-items-end">
      <div class="col-md-4">
        <label for="startDate" class="form-label">Start Date</label>
        <input type="date" id="startDate" class="form-control">
      </div>
      <div class="col-md-4">
        <label for="endDate" class="form-label">End Date</label>
        <input type="date" id="endDate" class="form-control">
      </div>
      <div class="col-md-4 d-flex gap-2">
        <button type="submit" class="btn btn-primary flex-grow-1">
          <i class="bx bx-filter-alt"></i> Apply Filter
        </button>
        <button type="button" class="btn btn-secondary flex-grow-1" id="resetFilterBtn">
          <i class="bx bx-reset"></i> Reset Filter
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Purchases Table -->
<div class="card shadow-sm">
  <div class="table-responsive text-nowrap" style="max-height: 80vh; overflow-y: auto;" id="purchases-scroll">
    <table class="table table-hover align-middle mb-0" id="purchasesTable">
      <thead class="table-light">
        <tr>
          <th>ID</th>
          <th>Date</th>
          <th>Variant</th>
          <th>Qty</th>
          <th>Purchase Price</th>
          <th>Discount</th>
          <th>GST</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody id="purchasesBody">
        <tr id="purchases-loader-row">
          <td colspan="8" class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const supplierId = "{{ pk }}";
  const purchasesUrl = `/admin_api/supplier-purchases/${supplierId}/`;
  const tbody = document.getElementById("purchasesBody");
  const scrollBox = document.getElementById("purchases-scroll");

  let page = 1;
  let nextPage = null;
  let isLoading = false;
  let startDate = "";
  let endDate = "";

  function fetchPurchases(initialLoad = false) {
    if (isLoading) return;
    isLoading = true;

    const loader = document.getElementById("purchases-loader-row");
    if (loader) loader.style.display = "";

    let url = `${purchasesUrl}?page=${page}`;
    if (startDate && endDate) url += `&start_date=${startDate}&end_date=${endDate}`;

    fetch(url)
      .then(res => res.json())
      .then(data => {
        const results = data.results || data;
        nextPage = data.next;

        if (initialLoad) tbody.innerHTML = "";
        if (loader) loader.style.display = "none";

        if (Array.isArray(results) && results.length > 0) {
          results.forEach(p => {
            let row = `
              <tr>
                <td>${p.id}</td>
                <td>${p.date}</td>
                <td>${p.variant}</td>
                <td>${p.quantity}</td>
                <td>â‚¹ ${p.purchase_price}</td>
                <td>â‚¹ ${p.discount}</td>
                <td>${p.gst}%</td>
                <td>â‚¹ ${p.total_price}</td>
              </tr>`;
            tbody.insertAdjacentHTML("beforeend", row);
          });
        } else if (initialLoad) {
          tbody.innerHTML = `
            <tr><td colspan="8" class="text-center text-muted py-4">No purchases found.</td></tr>`;
        }

        isLoading = false;
      })
      .catch(error => {
        console.error("Error fetching purchases:", error);
        isLoading = false;
      });
  }

  // ðŸ”¹ Initial Fetch
  fetchPurchases(true);

  // ðŸ”¹ Infinite Scroll
  scrollBox.addEventListener("scroll", () => {
    if (
      scrollBox.scrollTop + scrollBox.clientHeight >= scrollBox.scrollHeight - 50 &&
      nextPage && !isLoading
    ) {
      page++;
      fetchPurchases();
    }
  });

  // ðŸ”¹ Apply Filter
  document.getElementById("filterForm").addEventListener("submit", function (e) {
    e.preventDefault();
    startDate = document.getElementById("startDate").value;
    endDate = document.getElementById("endDate").value;

    if (startDate && !endDate) {
      const today = new Date().toISOString().split("T")[0];
      document.getElementById("endDate").value = today;
      endDate = today;
    }

    page = 1;
    nextPage = null;
    fetchPurchases(true);
  });

  // ðŸ”¹ Reset Filter
  document.getElementById("resetFilterBtn").addEventListener("click", function () {
    document.getElementById("startDate").value = "";
    document.getElementById("endDate").value = "";
    startDate = endDate = "";
    page = 1;
    nextPage = null;
    fetchPurchases(true);
  });

  // ðŸ”¹ Auto-open date picker
  [document.getElementById("startDate"), document.getElementById("endDate")].forEach(input => {
    input.addEventListener("focus", () => {
      if (input.showPicker) input.showPicker();
    });
  });

  // ðŸ”¹ Export PDF
  document.getElementById("exportPdfBtn").addEventListener("click", function () {
    const s = document.getElementById("startDate").value;
    const e = document.getElementById("endDate").value;
    let url = `/admin_api/supplier-purchases/${supplierId}/export_pdf/`;
    if (s && e) url += `?start_date=${s}&end_date=${e}`;
    window.location.href = url;
  });

  // ðŸ”¹ Print PDF (opens in new tab for direct printing)
  document.getElementById("printPdfBtn").addEventListener("click", function () {
    const s = document.getElementById("startDate").value;
    const e = document.getElementById("endDate").value;
    let url = `/admin_api/supplier-purchases/${supplierId}/print_pdf/`;
    if (s && e) url += `?start_date=${s}&end_date=${e}`;
    window.open(url, '_blank');  // Opens in new tab for printing
  });
});
</script>
{% endblock %}
