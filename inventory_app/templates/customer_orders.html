{% extends layout_path %}
{% load static %}
{% block title %}Customer Orders{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h4 class="fw-bold">
    Orders
  </h4>
    <div class="d-flex justify-content-end align-items-center mb-3 gap-2">
        <button type="button" class="btn btn-outline-success" id="exportExcelBtn">
            <i class="bx bx-file"></i> Export
        </button> 
        <button type="button" class="btn btn-outline-danger" id="exportPdfBtn">
            <i class="bx bxs-file-pdf"></i> Export PDF
        </button>
        <a href="/customer-list/" class="btn btn-primary">
            <i class="bx bx-arrow-back"></i> Back to Customers
        </a>
    </div>
</div>

<div class="card">
  <div class="table-responsive text-nowrap">
    <table class="table table-hover" id="ordersTable">
      <thead class="">
        <tr>
          <th>Order</th>
          <th>Order Date</th>
          <th>Total Amount</th>
          <th>Discount</th>
          <th>Final Amount</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="ordersBody">
        <tr>
          <td colspan="6" class="text-center text-muted py-4">Loading...</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const customerId = "{{pk}}";   // Django will inject customer ID
    const ordersUrl = `/admin_api/orders/${customerId}/`;   // JSON orders API
    const exportUrl = `/admin_api/customer-orders/${customerId}/export_excel/`; // Excel export API
    const exportPdfUrl = `/admin_api/customer-orders/${customerId}/export_pdf/`;
    // Fetch & render orders
    fetch(ordersUrl)
      .then(response => response.json())
      .then(data => {
        const tbody = document.getElementById("ordersBody");
        tbody.innerHTML = "";

        if (Array.isArray(data) && data.length > 0) {
          data.forEach(order => {
            let row = `
              <tr>
                <td>${order.id}</td>
                <td>${new Date(order.order_date).toLocaleString()}</td>
                <td>₹ ${order.total_amount}</td>
                <td>${order.is_percentage ? order.order_discount + "%" : "₹ " + order.order_discount}</td>
                <td>₹ ${order.final_amount}</td>
                <td>
                  <a href="customer-order-detail/${order.id}/" class="btn btn-sm btn-primary">
                    <i class="bx bx-show"></i> View
                  </a>
                </td>
              </tr>
            `;
            tbody.insertAdjacentHTML("beforeend", row);
          });
        } else {
          tbody.innerHTML = `
            <tr>
              <td colspan="6" class="text-center text-muted py-4">No orders found.</td>
            </tr>`;
        }
      })
      .catch(error => {
        console.error("Error fetching orders:", error);
      });

    // Handle Export to Excel
    document.getElementById("exportExcelBtn").addEventListener("click", function () {
      window.location.href = exportUrl; // Directly download Excel
    });

    document.getElementById("exportPdfBtn").addEventListener("click", function () {
        window.location.href = exportPdfUrl;
    });
    
  });
</script>


{% endblock %}
