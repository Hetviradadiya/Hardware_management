{% extends layout_path %}
{% load static %}
{% csrf_token %}
{% block title %}Bill Detail{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h4 class="fw-bold">Bill Detail</h4>
  <div>
    <a href="javascript:history.back()" class="btn btn-secondary me-2">
      <i class="bx bx-arrow-back"></i> Back
    </a>
    <button class="btn btn-primary me-2" onclick="editOrder()">
      <i class="bx bx-edit"></i> Edit Order
    </button>
    <button class="btn btn-warning" onclick="createReturn()">
      <i class="bx bx-undo"></i> Create Return
    </button>
  </div>
</div>

<div class="card p-4 shadow-sm">
  <div id="orderInfo" class="mb-4">
    <h5 class="fw-bold mb-3">Order Information</h5>
    <p><strong>Order:</strong> <span id="orderId">Loading...</span></p>
    <p><strong>Customer:</strong> <span id="customerName">Loading...</span></p>
    <p><strong>Order Date:</strong> <span id="orderDate">Loading...</span></p>
    <p><strong>Total Amount:</strong> ₹ <span id="totalAmount">0.00</span></p>
    <p><strong>Discount:</strong> <span id="discount">0.00</span></p>
    <p><strong>Final Amount:</strong> ₹ <span id="finalAmount">0.00</span></p>
  </div>

  <div>
    <h5 class="fw-bold mb-3">Order Items</h5>
    <div class="table-responsive">
      <table class="table table-striped">
        <thead class="">
          <tr>
            <th>#</th>
            <th>Product</th>
            <th>Size</th>
            <th>Price</th>
            <th>Quantity</th>
            <th>Discount</th>
            <th>GST</th>
            <th>Total</th>
            <th>Return Status</th>
          </tr>
        </thead>
        <tbody id="orderItemsBody">
          <tr>
            <td colspan="6" class="text-center text-muted py-4">Loading...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const orderId = "{{ pk }}";
    const url = `/admin_api/order/${orderId}/`; // your API endpoint for single order

    fetch(url)
      .then((res) => res.json())
      .then((data) => {
        if (data) {
          const order = data; // since your API already returns one order object

          // Fill order info
          document.getElementById("orderId").textContent = order.id;
          document.getElementById("customerName").textContent = order.customer_name;
          document.getElementById("orderDate").textContent = new Date(order.order_date).toLocaleString();
          document.getElementById("totalAmount").textContent = order.total_amount;
          document.getElementById("discount").textContent = order.is_percentage 
              ? order.order_discount + "%" 
              : "₹ " + order.order_discount;
          document.getElementById("finalAmount").textContent = order.calculate_total ?? order.final_amount;

          // Fill items
          const tbody = document.getElementById("orderItemsBody");
          tbody.innerHTML = "";
          if (order.order_items && order.order_items.length > 0) {
            order.order_items.forEach((item, idx) => {
              // Debug logging
              console.log('Order item:', item);
              console.log('is_return value:', item.is_return, 'type:', typeof item.is_return);
              
              // Ensure is_return is a boolean value
              const isReturned = Boolean(item.is_return);
              
              const returnCheckbox = `
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" 
                         id="return_${item.id}" 
                         ${isReturned ? 'checked' : ''} 
                         onchange="toggleReturnStatus(${item.id}, this.checked)">
                  <label class="form-check-label" for="return_${item.id}">
                    ${isReturned ? 'Returned' : 'Active'}
                  </label>
                </div>
              `;
              
              tbody.insertAdjacentHTML("beforeend", `
                <tr ${isReturned ? 'class="table-warning"' : ''}>
                  <td>${idx + 1}</td>
                  <td>${item.product_name}</td>
                  <td>${item.product_size ?? "-"}</td>
                  <td>₹ ${item.price_at_sale}</td>
                  <td>${item.quantity}</td>
                  <td>${item.is_percentage ? item.item_discount + "%" : "₹ " + item.item_discount}</td>
                  <td>₹ ${item.gst_amount}</td>
                  <td>₹ ${item.total_price}</td>
                  <td>${returnCheckbox}</td>
                </tr>
              `);
            });
          } else {
            tbody.innerHTML = `
              <tr>
                <td colspan="9" class="text-center text-muted py-4">No items in this order.</td>
              </tr>`;
          }
        }
      })
      .catch((err) => {
        console.error("Error fetching order:", err);
      });
  });

  // Functions for order management buttons
  function editOrder() {
    const orderId = document.getElementById('orderId').textContent;
    if (orderId && orderId !== 'Loading...') {
      window.location.href = `/order/${orderId}/`;
    }
  }

  function createReturn() {
    const orderId = document.getElementById('orderId').textContent;
    if (orderId && orderId !== 'Loading...') {
      // Simple return confirmation
      if (confirm('Create a return request for this order?')) {
        alert('Return functionality will be available from the main order page or returns management.');
        window.location.href = `/order/${orderId}/`;
      }
    }
  }

  function toggleReturnStatus(itemId, isReturned) {
    console.log('toggleReturnStatus called:', {itemId, isReturned}); // Debug log
    
    // Show loading state
    const checkbox = document.getElementById(`return_${itemId}`);
    const label = checkbox.nextElementSibling;
    const originalText = label.textContent;
    const originalChecked = checkbox.checked;
    
    label.textContent = 'Updating...';
    checkbox.disabled = true;

    // Get CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                     document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
    
    console.log('CSRF Token:', csrfToken); // Debug log
    console.log('API URL:', `/admin_api/order-items/${itemId}/toggle-return/`); // Debug log

    // Make API call to update return status
    fetch(`/admin_api/order-items/${itemId}/toggle-return/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken,
      },
      body: JSON.stringify({ is_return: isReturned })
    })
    .then(response => {
      console.log('Response status:', response.status); // Debug log
      console.log('Response headers:', response.headers); // Debug log
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      console.log('Response data:', data); // Debug log
      
      if (data.success) {
        // Additional verification logging
        console.log('Database update verification:', {
          'old_value': data.old_value,
          'new_value': data.is_return,
          'confirmed_saved': data.confirmed_saved
        });
        
        // Update UI
        label.textContent = isReturned ? 'Returned' : 'Active';
        const row = checkbox.closest('tr');
        if (isReturned) {
          row.classList.add('table-warning');
        } else {
          row.classList.remove('table-warning');
        }
        
        // Show success notification with verification details
        let message = data.message || 'Return status updated successfully';
        if (data.confirmed_saved) {
          message += ' ✓ Database confirmed';
        } else {
          message += ' ⚠️ Database update not confirmed';
        }
        
        showSuccessToast(message);
        
        // Optional: Re-fetch order data to verify database persistence
        setTimeout(() => {
          verifyDatabaseUpdate(itemId, isReturned);
        }, 1000); // Wait 1 second then verify
      } else {
        // Revert checkbox state
        checkbox.checked = originalChecked;
        label.textContent = originalText;
        
        // Show error notification
        showErrorToast(data.message || 'Failed to update return status');
      }
    })
    .catch(error => {
      console.error('Error updating return status:', error);
      
      // Revert checkbox state
      checkbox.checked = originalChecked;
      label.textContent = originalText;
      
      // Show detailed error notification
      let errorMessage = 'Network error occurred';
      if (error.message.includes('404')) {
        errorMessage = 'API endpoint not found. Please check the URL configuration.';
      } else if (error.message.includes('403')) {
        errorMessage = 'Permission denied. Please check your access rights.';
      } else if (error.message.includes('400')) {
        errorMessage = 'Bad request. Please check the data being sent.';
      }
      
      showErrorToast(errorMessage);
    })
    .finally(() => {
      checkbox.disabled = false;
    });
  }

  // Function to verify database persistence by re-fetching order data
  function verifyDatabaseUpdate(itemId, expectedValue) {
    console.log('Verifying database update for item:', itemId, 'expected:', expectedValue);
    
    const orderId = document.getElementById('orderId').textContent;
    if (orderId && orderId !== 'Loading...') {
      fetch(`/admin_api/order/${orderId}/`)
        .then(response => response.json())
        .then(data => {
          if (data && data.order_items) {
            const item = data.order_items.find(item => item.id == itemId);
            if (item) {
              const actualValue = Boolean(item.is_return);
              console.log('Database verification:', {
                itemId: itemId,
                expected: expectedValue,
                actual: actualValue,
                matches: actualValue === expectedValue
              });
              
              if (actualValue === expectedValue) {
                console.log('✓ Database update confirmed: is_return =', actualValue);
              } else {
                console.warn('⚠️ Database mismatch: expected', expectedValue, 'but got', actualValue);
                showErrorToast('Database update verification failed');
              }
            } else {
              console.warn('Item not found in verification response');
            }
          }
        })
        .catch(error => {
          console.error('Verification failed:', error);
        });
    }
  }

  // Toast notification functions (fallback if not available globally)
  function showSuccessToast(message) {
    if (typeof showToast === 'function') {
      showToast('Success', message, 'success');
    } else if (typeof window.showToast === 'function') {
      window.showToast('Success', message, 'success');
    } else {
      console.log('Success:', message);
      alert('Success: ' + message); // Fallback to alert for debugging
    }
  }

  function showErrorToast(message) {
    if (typeof showToast === 'function') {
      showToast('Error', message, 'danger');
    } else if (typeof window.showToast === 'function') {
      window.showToast('Error', message, 'danger');
    } else {
      console.error('Error:', message);
      alert('Error: ' + message); // Fallback to alert for debugging
    }
  }

  // Utility function for CSRF token (if not already available)
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
</script>
{% endblock %}
