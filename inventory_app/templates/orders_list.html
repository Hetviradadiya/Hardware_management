{% extends layout_path %}
{% load static %}
{% block title %}All Orders{% endblock %}

{% block page_js %}
<script>
let allOrdersData = [];
let filteredOrdersData = [];
let currentOrdersPage = 1;
const ordersPerPage = 15;

// Add some custom CSS for better status dropdown styling
const style = document.createElement('style');
style.textContent = `
    .status-dropdown {
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 12px;
        min-width: 120px;
        background-color: white;
    }
    .status-dropdown:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }
    .status-dropdown option.text-warning { color: #856404 !important; }
    .status-dropdown option.text-info { color: #0c5460 !important; }
    .status-dropdown option.text-success { color: #155724 !important; }
    .status-dropdown option.text-danger { color: #721c24 !important; }
`;
document.head.appendChild(style);

document.addEventListener('DOMContentLoaded', function() {
    loadAllOrders();
});

function loadAllOrders() {
    const tbody = document.getElementById('orders-tbody');
    tbody.innerHTML = `
        <tr>
            <td colspan="7" class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </td>
        </tr>
    `;

    fetch('/admin_api/order-management/')
    .then(response => response.json())
    .then(data => {
        console.log('Orders API response:', data);
        allOrdersData = data || [];
        filteredOrdersData = [...allOrdersData];
        renderOrdersTable();
        updateOrdersStats();
    })
    .catch(error => {
        console.error('Error loading orders:', error);
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-danger">
                    Error loading orders. Please try again.
                </td>
            </tr>
        `;
    });
}

function renderOrdersTable() {
    const tbody = document.getElementById('orders-tbody');
    tbody.innerHTML = '';

    if (filteredOrdersData.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-muted">
                    No orders found
                </td>
            </tr>
        `;
        document.getElementById('orders-count-info').textContent = 'No orders found';
        return;
    }

    // Pagination
    const startIndex = (currentOrdersPage - 1) * ordersPerPage;
    const endIndex = startIndex + ordersPerPage;
    const paginatedOrders = filteredOrdersData.slice(startIndex, endIndex);

    paginatedOrders.forEach(order => {
        const paymentStatus = getOrderPaymentStatus(order);
        const paymentBadge = getPaymentStatusBadge(paymentStatus);
        const statusBadge = getOrderStatusBadge(order.status || 'pending');
        const orderDate = order.order_date || order.created_at;
        const customerName = order.customer?.name || order.customer_name || 'Walk-in Customer';
        const totalAmount = parseFloat(order.total_amount || 0);
        const returnAmount = parseFloat(order.return_amount || 0);
        const netAmount = totalAmount - returnAmount;
        
        const row = `
            <tr>
                <td>
                    <strong>#${order.id}</strong>
                </td>
                <td>${customerName}</td>
                <td>${orderDate ? new Date(orderDate).toLocaleDateString() : 'N/A'}</td>
                <td>₹${totalAmount.toFixed(2)}</td>
                <td>
                    <span class="text-danger">
                        ${returnAmount > 0 ? '₹' + returnAmount.toFixed(2) : '-'}
                    </span>
                </td>
                <td>
                    <strong class="text-success">₹${netAmount.toFixed(2)}</strong>
                </td>
                <td>${paymentBadge}</td>
                <td>${getOrderStatusDropdown(order.id, order.status || 'pending')}</td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary btn-sm" onclick="viewOrderDetails(${order.id})" title="View Details">
                            <i class="bx bx-eye"></i> View
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="editOrder(${order.id})" title="Edit Order">
                            <i class="bx bx-edit"></i> Edit
                        </button>
                    </div>
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });

    // Update pagination
    renderOrdersPagination();
    
    // Update count info
    document.getElementById('orders-count-info').textContent = 
        `Showing ${startIndex + 1}-${Math.min(endIndex, filteredOrdersData.length)} of ${filteredOrdersData.length} orders`;
}

function getOrderPaymentStatus(order) {
    const total = parseFloat(order.total_amount || 0);
    const paid = parseFloat(order.paid_amount || 0);
    
    if (paid >= total) return 'paid';
    if (paid > 0) return 'partial';
    return 'unpaid';
}

function getPaymentStatusBadge(status) {
    const badges = {
        'paid': '<span class="badge bg-success">Paid</span>',
        'partial': '<span class="badge bg-warning">Partial</span>',
        'unpaid': '<span class="badge bg-danger">Unpaid</span>'
    };
    return badges[status] || '<span class="badge bg-secondary">Unknown</span>';
}

function getOrderStatusBadge(status) {
    const badges = {
        'pending': '<span class="badge bg-warning">Pending</span>',
        'confirmed': '<span class="badge bg-info">Confirmed</span>',
        'completed': '<span class="badge bg-success">Completed</span>',
        'cancelled': '<span class="badge bg-danger">Cancelled</span>'
    };
    return badges[status] || '<span class="badge bg-secondary">' + status + '</span>';
}

function getOrderStatusDropdown(orderId, currentStatus) {
    const statusOptions = [
        { value: 'pending', label: 'Pending', class: 'text-warning' },
        { value: 'confirmed', label: 'Confirmed', class: 'text-info' },
        { value: 'completed', label: 'Completed', class: 'text-success' },
        { value: 'cancelled', label: 'Cancelled', class: 'text-danger' }
    ];
    
    let optionsHtml = '';
    statusOptions.forEach(option => {
        const selected = option.value === currentStatus ? 'selected' : '';
        optionsHtml += `<option value="${option.value}" class="${option.class}" ${selected}>${option.label}</option>`;
    });
    
    return `
        <select class="form-select form-select-sm status-dropdown" 
                onchange="updateOrderStatus(${orderId}, this.value, this)" 
                data-original-status="${currentStatus}">
            ${optionsHtml}
        </select>
    `;
}

function updateOrderStatus(orderId, newStatus, selectElement) {
    const originalStatus = selectElement.getAttribute('data-original-status') || selectElement.value;
    
    // Show loading state
    selectElement.disabled = true;
    selectElement.style.opacity = '0.6';
    
    fetch(`/admin_api/order-management/${orderId}/update_status/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            status: newStatus
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            // Revert to original status on error
            selectElement.value = originalStatus;
            showErrorToast(data.error);
        } else {
            // Update the original status data attribute
            selectElement.setAttribute('data-original-status', newStatus);
            
            // Update the order data in our local array
            const orderIndex = allOrdersData.findIndex(order => order.id === orderId);
            if (orderIndex !== -1) {
                allOrdersData[orderIndex].status = newStatus;
                // Also update filtered data
                const filteredIndex = filteredOrdersData.findIndex(order => order.id === orderId);
                if (filteredIndex !== -1) {
                    filteredOrdersData[filteredIndex].status = newStatus;
                }
            }
            
            showSuccessToast(`Order #${orderId} status updated to ${newStatus}`);
            updateOrdersStats(); // Refresh statistics
        }
    })
    .catch(error => {
        console.error('Error updating order status:', error);
        // Revert to original status on error
        selectElement.value = originalStatus;
        showErrorToast('Failed to update order status');
    })
    .finally(() => {
        // Remove loading state
        selectElement.disabled = false;
        selectElement.style.opacity = '1';
    });
}

function filterOrders() {
    const searchTerm = document.getElementById('order-search').value.toLowerCase();
    const statusFilter = document.getElementById('order-status-filter').value;
    const paymentFilter = document.getElementById('order-payment-filter').value;

    filteredOrdersData = allOrdersData.filter(order => {
        const matchesSearch = !searchTerm || 
            order.id.toString().includes(searchTerm) ||
            (order.customer?.name || order.customer_name || '').toLowerCase().includes(searchTerm);
        
        const matchesStatus = !statusFilter || (order.status || 'pending') === statusFilter;
        
        const paymentStatus = getOrderPaymentStatus(order);
        const matchesPayment = !paymentFilter || paymentStatus === paymentFilter;

        return matchesSearch && matchesStatus && matchesPayment;
    });

    currentOrdersPage = 1; // Reset to first page
    renderOrdersTable();
}

function renderOrdersPagination() {
    const totalPages = Math.ceil(filteredOrdersData.length / ordersPerPage);
    const paginationEl = document.getElementById('orders-pagination');
    
    if (totalPages <= 1) {
        paginationEl.innerHTML = '';
        return;
    }

    let paginationHTML = '';
    
    // Previous button
    if (currentOrdersPage > 1) {
        paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="changeOrdersPage(${currentOrdersPage - 1})">Previous</a></li>`;
    }
    
    // Page numbers
    for (let i = 1; i <= totalPages; i++) {
        if (i === currentOrdersPage) {
            paginationHTML += `<li class="page-item active"><a class="page-link" href="#">${i}</a></li>`;
        } else {
            paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="changeOrdersPage(${i})">${i}</a></li>`;
        }
    }
    
    // Next button
    if (currentOrdersPage < totalPages) {
        paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="changeOrdersPage(${currentOrdersPage + 1})">Next</a></li>`;
    }
    
    paginationEl.innerHTML = paginationHTML;
}

function changeOrdersPage(page) {
    currentOrdersPage = page;
    renderOrdersTable();
}

function refreshOrdersList() {
    loadAllOrders();
}

function viewOrderDetails(orderId) {
    window.location.href = `/order/${orderId}/`;
}

function editOrder(orderId) {
    window.location.href = `/order/${orderId}/`;
}

function updateOrdersStats() {
    const stats = {
        total: allOrdersData.length,
        pending: allOrdersData.filter(order => (order.status || 'pending') === 'pending').length,
        completed: allOrdersData.filter(order => (order.status || 'pending') === 'completed').length,
        paid: allOrdersData.filter(order => getOrderPaymentStatus(order) === 'paid').length,
        unpaid: allOrdersData.filter(order => getOrderPaymentStatus(order) === 'unpaid').length
    };

    document.getElementById('total-orders').textContent = stats.total;
    document.getElementById('pending-orders').textContent = stats.pending;
    document.getElementById('completed-orders').textContent = stats.completed;
    document.getElementById('paid-orders').textContent = stats.paid;
    document.getElementById('unpaid-orders').textContent = stats.unpaid;
}
</script>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="fw-bold">All Orders</h4>
        <div class="d-flex gap-2">
            <button class="btn btn-primary" onclick="refreshOrdersList()">
                <i class="bx bx-refresh"></i> Refresh
            </button>
            <a href="javascript:history.back()" class="btn btn-secondary">
                <i class="bx bx-arrow-back"></i> Back
            </a>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-primary" id="total-orders">0</h3>
                    <small class="text-muted">Total Orders</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-warning" id="pending-orders">0</h3>
                    <small class="text-muted">Pending</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-success" id="completed-orders">0</h3>
                    <small class="text-muted">Completed</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-info" id="paid-orders">0</h3>
                    <small class="text-muted">Paid Orders</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-danger" id="unpaid-orders">0</h3>
                    <small class="text-muted">Unpaid Orders</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <label class="form-label">Search Orders</label>
                    <input type="text" class="form-control" id="order-search" placeholder="Search by Order ID, Customer..." onkeyup="filterOrders()">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Order Status</label>
                    <select class="form-select" id="order-status-filter" onchange="filterOrders()">
                        <option value="">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="confirmed">Confirmed</option>
                        <option value="completed">Completed</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Payment Status</label>
                    <select class="form-select" id="order-payment-filter" onchange="filterOrders()">
                        <option value="">All Payments</option>
                        <option value="paid">Paid</option>
                        <option value="partial">Partial</option>
                        <option value="unpaid">Unpaid</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <button class="btn btn-outline-secondary w-100" onclick="document.getElementById('order-search').value=''; document.getElementById('order-status-filter').value=''; document.getElementById('order-payment-filter').value=''; filterOrders();">
                        <i class="bx bx-x"></i> Clear
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Orders Table -->
    <div class="card">
        <div class="card-header">
            <h6 class="mb-0">Orders List</h6>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Date</th>
                            <th>Total Amount</th>
                            <th>Return Amount</th>
                            <th>Net Amount</th>
                            <th>Payment Status</th>
                            <th>Order Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="orders-tbody">
                        <tr>
                            <td colspan="9" class="text-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="d-flex justify-content-between align-items-center mt-3">
                <div>
                    <span id="orders-count-info">Loading orders...</span>
                </div>
                <nav>
                    <ul class="pagination pagination-sm" id="orders-pagination">
                        <!-- Pagination will be generated dynamically -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

{% csrf_token %}
{% endblock %}