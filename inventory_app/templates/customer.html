{% extends layout_path %}
{% load static %}
{% block title %}Manage Customer{% endblock %}

{% block content %}
<div class="row">
  <div class="col-xxl">
    <div class="card mb-6">
      <div class="card-header d-flex align-items-center justify-content-between">
        <h5 class="mb-0">Add Customer</h5>
      </div>
      <div class="card-body">

        <!-- Loader -->
        <div id="form-loader" class="text-center my-4" style="display: none;">
          <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
        </div>

        <!-- Toast -->
        <div class="bs-toast toast toast-placement-ex m-2" id="alert-box" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="2000">
          <div class="toast-header">
            <i class="bx bx-bell me-2" id="toast-icon"></i>
            <div class="me-auto fw-medium" id="toast-title">Notification</div>
            <small class="toast-time">Now</small>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
          </div>
          <div class="toast-body" id="toast-body"></div>
        </div>

        <!-- Form -->
        <form id="customer-form" style="display: none;">
          {% csrf_token %}

          <div class="row mb-4">
            <label class="col-sm-2 col-form-label" for="name">Name</label>
            <div class="col-sm-10">
              <input type="text" id="name" class="form-control" required />
              <div class="invalid-feedback" id="name-error" style="display: none;"></div>
            </div>
          </div>

          <div class="row mb-4">
            <label class="col-sm-2 col-form-label" for="phone">Phone <small class="text-muted">(Optional)</small></label>
            <div class="col-sm-10">
              <input type="text" id="phone" class="form-control" placeholder="Enter phone number (optional)"/>
              <div class="invalid-feedback" id="phone-error" style="display: none;"></div>
            </div>
          </div>

          <div class="row mb-4">
            <label class="col-sm-2 col-form-label" for="email">Email <small class="text-muted">(Optional)</small></label>
            <div class="col-sm-10">
              <input type="email" id="email" class="form-control" placeholder="Enter email address (optional)" />
              <div class="invalid-feedback" id="email-error" style="display: none;"></div>
            </div>
          </div>

          <div class="row mb-4">
            <label class="col-sm-2 col-form-label" for="address">Address <small class="text-muted">(Optional)</small></label>
            <div class="col-sm-10">
              <textarea id="address" class="form-control" placeholder="Enter address (optional)"></textarea>
            </div>
          </div>

          <!-- Buttons -->
          <div class="row justify-content-end">
            <div class="col-sm-12">
              {% if view_only == 'false' %}
                <button type="submit" class="btn btn-primary" id="submit-button">Add Customer</button>
              {% endif %}
              <button type="button" class="btn btn-secondary" id="back-button" onclick="goBackToCustomerList()">Back</button>
            </div>
          </div>
        </form>

      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block page_js %}
<script>
  const form = document.getElementById("customer-form");
  const loader = document.getElementById("form-loader");
  const customerId = "{{ id|default:'' }}";
  const isView = "{{ view_only|default:'false' }}" === 'true';
  const isEdit = Boolean(customerId) && !isView;

  document.addEventListener("DOMContentLoaded", () => {
    const submitBtn = document.getElementById("submit-button");
    const formHeading = document.querySelector(".card-header h5");

    if (isView) {
      formHeading.textContent = "View Customer";
      document.title = "View Customer";
      if (submitBtn) submitBtn.style.display = "none";
    } else if (isEdit) {
      formHeading.textContent = "Edit Customer";
      document.title = "Edit Customer";
      if (submitBtn) submitBtn.textContent = "Update Customer";
    } else {
      formHeading.textContent = "Add Customer";
      document.title = "Add Customer";
    }

    if (isEdit || isView) {
      loadCustomer(customerId);
    } else {
      form.style.display = "block";
    }
  });

  function loadCustomer(id) {
    fetch(`/admin_api/customers/${id}/`)
      .then(res => res.json())
      .then(data => {
        document.getElementById("name").value = data.name || '';
        document.getElementById("phone").value = data.phone || '';
        document.getElementById("email").value = data.email || '';
        document.getElementById("address").value = data.address || '';

        if (isView) {
          form.querySelectorAll("input, textarea, button").forEach(el => {
            if (el.id !== "back-button") el.disabled = true;
          });
        }
        form.style.display = "block";
      })
      .catch(err => {
        console.error("Failed to load customer:", err);
        showToast("Error", "Failed to load data", "danger");
      });
  }

  form.addEventListener("submit", function (e) {
    e.preventDefault();
    if (isView) return;

    console.log("Form submitted, starting customer creation/update...");
    
    loader.style.display = "block";
    form.style.display = "none";

    const payload = {
      name: document.getElementById("name").value,
      phone: document.getElementById("phone").value.trim() || null, // Send null for empty phone
      email: document.getElementById("email").value.trim() || null, // Send null for empty email
      address: document.getElementById("address").value.trim() || null // Send null for empty address
    };

    console.log("Payload:", payload);

    const url = isEdit
      ? `/admin_api/customers/${customerId}/`
      : `/admin_api/customers/`;
    const method = isEdit ? "PATCH" : "POST";

    console.log(`Making ${method} request to ${url}`);

    // Get CSRF token
    const csrfToken = getCookie("csrftoken");
    console.log("CSRF Token:", csrfToken ? "Present" : "Missing");

    fetch(url, {
      method: method,
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrfToken
      },
      body: JSON.stringify(payload)
    })
      .then(res => {
        console.log("Response status:", res.status);
        loader.style.display = "none";
        if (res.ok) {
          return res.json().then(data => {
            console.log("Success response data:", data);
            showToast("Success", `Customer ${isEdit ? "updated" : "added"} successfully`, "success");
            
            // Redirect immediately for better user experience
            console.log("Redirecting to customer list...");
            window.location.href = "/customer-list/";
          }).catch(jsonErr => {
            // If JSON parsing fails but response was ok, still redirect
            console.log("JSON parse error but response was ok, redirecting anyway");
            showToast("Success", `Customer ${isEdit ? "updated" : "added"} successfully`, "success");
            window.location.href = "/customer-list/";
          });
        } else {
          return res.json().then(data => {
            console.log("Error response data:", data);
            form.style.display = "block";
            
            // Clear previous errors
            clearFieldErrors();
            
            // Handle field-specific errors
            if (data.field) {
              showFieldError(data.field, data.message);
            } else {
              const error = data?.detail || data?.message || "Operation failed.";
              showToast("Error", error, "danger");
            }
          });
        }
      })
      .catch(err => {
        console.error("Customer operation error:", err);
        loader.style.display = "none";
        form.style.display = "block";
        showToast("Error", "Something went wrong. Please try again.", "danger");
      });
  });

  function showToast(title, message, status) {
    const toast = document.getElementById("alert-box");
    document.getElementById("toast-title").textContent = title;
    document.getElementById("toast-body").textContent = message;
    document.getElementById("toast-icon").className = `bx me-2 ${status === "success" ? "bx-check-circle" : "bx-error"}`;
    toast.className = `bs-toast toast bg-${status} toast-placement-ex top-0 end-0 m-2 show`;
    new bootstrap.Toast(toast).show();
  }

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function goBackToCustomerList() {
    console.log("Navigating back to customer list...");
    window.location.href = "/customer-list/";
  }

  function clearFieldErrors() {
    // Clear all field error states
    const fields = ['phone', 'email', 'name'];
    fields.forEach(fieldName => {
      const field = document.getElementById(fieldName);
      const errorDiv = document.getElementById(fieldName + '-error');
      
      if (field) {
        field.classList.remove('is-invalid');
      }
      if (errorDiv) {
        errorDiv.style.display = 'none';
        errorDiv.textContent = '';
      }
    });
  }

  function showFieldError(fieldName, message) {
    const field = document.getElementById(fieldName);
    const errorDiv = document.getElementById(fieldName + '-error');
    
    if (field) {
      field.classList.add('is-invalid');
      field.focus(); // Focus on the field with error
    }
    
    if (errorDiv) {
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
    }
    
    // Also show a toast for better visibility
    showToast("Validation Error", message, "danger");
  }

  // Clear field errors when user starts typing
  document.addEventListener('DOMContentLoaded', function() {
    const fields = ['name', 'phone', 'email'];
    
    fields.forEach(fieldName => {
      const field = document.getElementById(fieldName);
      if (field) {
        field.addEventListener('input', function() {
          this.classList.remove('is-invalid');
          const errorDiv = document.getElementById(fieldName + '-error');
          if (errorDiv) {
            errorDiv.style.display = 'none';
          }
        });
      }
    });
  });
</script>
{% endblock %}
